<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="genAI.png" rel="icon" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <title>Gen AI Prompt Constructor</title>
  <style>
    body{font-family:Arial, sans-serif;margin:20px;background:#f4f4f4;color:#333}
    .container{max-width:1100px;margin:0 auto;background:#fff;padding:30px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.1)}
    h1,h2{color:#0056b3}
    label{display:block;margin-bottom:8px;font-weight:bold}
    textarea,select,input[type="text"]{width:100%;padding:10px;margin-bottom:20px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;min-height:40px;resize:vertical}
    textarea{min-height:100px}
    select{height:40px;background:#f8f8f8}
    button{background:#007bff;color:#fff;padding:12px 20px;border:none;border-radius:4px;cursor:pointer;font-size:16px;transition:background .3s;margin-top:10px}
    button:hover{background:#0056b3}
    .section-title{margin-bottom:15px;font-size:1.2em;color:#555;padding-top:10px;border-top:1px solid #eee;margin-top:20px}
    .method-section{display:none}
    .method-section.active{display:block}
    ul{margin-bottom:20px;padding-left:20px}
    ul li{margin-bottom:5px}

    /* Alerts */
    .alert{padding:20px;margin-bottom:20px;border:1px solid transparent;border-radius:4px;position:relative;opacity:1;transition:opacity .6s}
    .alert.success{background:#d4edda;color:#155724;border-color:#c3e6cb}
    .alert.warning{background:#fff3cd;color:#856404;border-color:#ffeeba}
    .alert.error{background:#f8d7da;color:#721c24;border-color:#f5c6cb}
    .closebtn{margin-left:15px;color:inherit;font-weight:bold;float:right;font-size:22px;line-height:20px;cursor:pointer;transition:.3s}
    .closebtn:hover{opacity:.7}

    /* Accordion */
    #sessionPromptHistoryContainer,#searchResultsContainer{margin-top:30px;border:1px solid #dee2e6;border-radius:8px;overflow:hidden;padding:1px}
    .accordion-item{border-bottom:1px solid #e0e0e0}
    .accordion-item:last-child{border-bottom:none}
    .accordion-button{background:#f8f9fa;color:#495057;cursor:pointer;padding:15px 20px;width:100%;text-align:left;border:none;outline:none;transition:background .3s;font-size:1.1em;font-weight:bold;display:flex;justify-content:space-between;align-items:center;margin-top:0}
    .accordion-button:hover{background:#e2e6ea}
    .accordion-button.active{background:#e9ecef;color:#0056b3}
    .accordion-button:after{content:'\02795';font-size:.8em;color:#777;margin-left:5px;transition:transform .3s}
    .accordion-button.active:after{content:'\2796'}
    .accordion-panel{padding:0 20px;background:#fff;max-height:0;overflow:hidden;transition:max-height .3s ease-out,padding .3s ease-out;box-sizing:border-box;padding-bottom:0}
    .accordion-panel.active{padding-top:15px;padding-bottom:15px}
    .accordion-panel pre{background:#e9ecef;padding:15px;border-radius:4px;white-space:pre-wrap;word-wrap:break-word;font-family:monospace;font-size:.9em;margin:0;line-height:1.4em}
    .button-group{text-align:right;margin-top:15px}
    .button-group button{padding:8px 15px;font-size:14px;margin-left:10px;border-radius:4px;border:none;cursor:pointer}
    .copy-button{background:#28a745!important;color:#fff!important}
    .copy-button:hover{background:#218838!important}
    .load-button{background:#17a2b8!important}
    .load-button:hover{background:#138496!important}
    .delete-button{background:#dc3545!important}
    .delete-button:hover{background:#c82333!important}
    .no-prompts-message{text-align:center;color:#6c757d;padding:20px}

    /* Search controls */
    .search-controls{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:20px;align-items:flex-end}
    .search-controls>div{flex:1 0 150px;margin-bottom:0}
    .pagination-controls{text-align:center;margin-top:20px}
    .pagination-controls button{padding:8px 15px;margin:0 5px;background:#6c757d;color:#fff;border:none;border-radius:4px;cursor:pointer}
    .pagination-controls button:disabled{background:#e9ecef;color:#6c757d;cursor:not-allowed}
    .pagination-controls span{font-weight:bold;margin:0 10px}

    /* Tooltips */
    .tooltip{position:relative;display:inline-block;cursor:help;color:#007bff;font-weight:normal;margin-left:5px}
    .tooltip .tooltiptext{visibility:hidden;width:400px;max-height:250px;overflow-y:auto;background:#333;color:#fff;text-align:left;border-radius:6px;padding:10px;position:absolute;z-index:100;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .3s;font-size:.85em;line-height:1.4em}
    .tooltip:hover .tooltiptext{visibility:visible;opacity:1}
    .tooltip i.tooltip-icon{font-size:22px;color:#007bff;margin-left:6px;cursor:pointer;transition:color .2s}
    .tooltip i.tooltip-icon:hover{color:#0056b3}

    /* Chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:-10px 0 12px 0}
    .chip{background:#eef5ff;color:#0056b3;border:1px solid #cfe2ff;padding:6px 10px;border-radius:16px;font-size:.85em;cursor:pointer}
    .chip:hover{background:#e2ecff}

    /* Layout with side panel */
    .flex-wrap{display:grid;grid-template-columns:1fr 320px;gap:18px}
    @media (max-width:1024px){.flex-wrap{grid-template-columns:1fr}}

    /* Side panel */
    .side-panel{position:sticky;top:12px;align-self:start;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:14px}
    .side-panel h3{margin:6px 0 10px 0;font-size:1.05rem;color:#333}
    .side-panel .meter{font-size:.9em;color:#555;margin:4px 0 8px 0}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f5f9;font-size:.75em;margin-right:6px}

    /* Preview */
    .preview{white-space:pre-wrap;border:1px solid #e5e7eb;border-radius:8px;padding:12px;background:#f9fafb;font-family:system-ui,sans-serif;font-size:.92em}
    .preview-toolbar{display:flex;gap:8px;margin:8px 0 10px}
    .btn-sm{padding:6px 10px;font-size:.85em;border-radius:6px;background:#6c757d;color:#fff;border:none}
    .btn-sm:hover{background:#5a636a}
    .btn-outline{background:#fff;color:#333;border:1px solid #d1d5db}
    .btn-outline:hover{background:#f3f4f6}

    /* Inline controls */
    .inline-controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 16px}
    .inline-controls select,.inline-controls input[type="text"]{margin:0;height:36px}
  </style>
</head>
<body>
  <div class="container">
    <div id="alert-banner" class="alert" style="display:none;">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
      <span id="alert-message"></span>
    </div>

    <h1>Gen AI Prompt Constructor</h1>

    <label for="methodSelector">Select Prompt Method:</label>
    <select id="methodSelector" onchange="showMethodFields()">
      <option value="tcrei">TCREI Method (Text Generation)</option>
      <option value="design">DESIGN Method (Image Generation)</option>
       <option value="agent">Agent Mode (Research & Implement)</option>
    </select>

    <hr>

    <!-- Controls row: presets, mode, variables -->
    <div class="inline-controls">
      <label style="font-weight:600;">Template:</label>
      <select id="templatePreset" onchange="applyTemplate(this.value)">
        <option value="">— Select a preset —</option>
        <option value="blog">Blog Post</option>
        <option value="product">Product Description</option>
        <option value="email">Email Campaign</option>
        <option value="bug">Bug Report</option>
      </select>

      <label style="font-weight:600;">Mode:</label>
      <select id="modeSelector" onchange="renderPreview()">
        <option value="">None</option>
        <option value="concise">Be concise</option>
        <option value="creative">Be creative</option>
        <option value="factual">Be factual, cite sources</option>
      </select>

      <label style="font-weight:600;">Audience:</label>
      <input type="text" id="varAudience" placeholder="e.g., non-technical SMB owners" oninput="renderPreview()">
      <label style="font-weight:600;">Tone:</label>
      <input type="text" id="varTone" placeholder="e.g., friendly, professional" oninput="renderPreview()">
      <label style="font-weight:600;">Length:</label>
      <input type="text" id="varLength" placeholder="e.g., ~800 words" oninput="renderPreview()">
    </div>

    <div class="flex-wrap">
      <div>
        <!-- TCREI -->
        <div id="tcreiMethod" class="method-section active">
          <h2>TCREI Method (Text Generation)</h2>
          <p>Using Google's TCREI Method:</p>
          <ul>
            <li><strong>T</strong>houghtfully: Describe your <strong>task</strong>, specifying a persona and format preference.</li>
            <li><strong>C</strong>reate: Include any <strong>context</strong> the gen AI tool might need.</li>
            <li><strong>R</strong>eally: Add <strong>references</strong> the gen AI tool can use to inform its output.</li>
            <li><strong>E</strong>xcellent: Evaluate the output and spot improvements (after generation).</li>
            <li><strong>I</strong>nputs: Iterate on your prompt to attain those improvements (after generation).</li>
          </ul>

          <!-- Thoughtfully (Task) -->
          <div class="section-title">Thoughtfully (Task)</div>
          <label for="tcrei_task">
            Describe your task:
            <span class="tooltip">
              <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
              <span class="tooltiptext">
                • Write a blog post explaining {{topic}} to {{audience}}<br>
                • Summarise a research paper into a 1-page brief<br>
                • Translate a product description to Spanish (friendly tone)<br>
                • Script a 2-minute explainer on renewable energy<br>
                • Generate 15 quiz questions (with answers)<br>
              </span>
            </span>
          </label>
          <textarea id="tcrei_task" placeholder="e.g., 'Write a compelling blog post…'"></textarea>
          <div class="chips">
            <span class="chip" onclick="insertChip('tcrei_task','Write a blog post explaining {{topic}} to {{audience}}.')">Task: blog post</span>
            <span class="chip" onclick="insertChip('tcrei_task','Summarise the following into key bullet points for {{audience}}.')">Task: summary</span>
            <span class="chip" onclick="insertChip('tcrei_task','Translate this into Spanish, preserve line breaks, friendly tone.')">Task: translate</span>
            <span class="chip" onclick="randomiseField('tcrei_task','task')">Randomise</span>
          </div>

          <!-- Specify Format or Persona -->
          <div class="section-title">Specify Format or Persona</div>
          <label for="tcrei_format">
            Format / persona:
            <span class="tooltip">
              <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
              <span class="tooltiptext">
                • Formatted in Markdown<br>
                • As a bulleted list<br>
                • Persona: senior cybersecurity consultant<br>
                • Written in a humorous, sarcastic tone<br>
              </span>
            </span>
          </label>
          <textarea id="tcrei_format" placeholder="e.g., 'Formatted in Markdown' or 'Persona: …'"></textarea>
          <div class="chips">
            <span class="chip" onclick="insertChip('tcrei_format','Formatted in Markdown')">Markdown</span>
            <span class="chip" onclick="insertChip('tcrei_format','As bullet points with sub-bullets')">Bulleted</span>
            <span class="chip" onclick="insertChip('tcrei_format','Persona: Act as a senior cybersecurity consultant')">Persona</span>
            <span class="chip" onclick="insertChip('tcrei_format','Tone: {{tone}}')">Tone</span>
          </div>

          <!-- Create (Context) -->
          <div class="section-title">Create (Context)</div>
          <label for="tcrei_context">
            Context:
            <span class="tooltip">
              <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
              <span class="tooltiptext">
                • Audience: {{audience}}<br>
                • Length: {{length}}<br>
                • Include 3 real-world examples<br>
                • Use UK English spelling<br>
              </span>
            </span>
          </label>
          <textarea id="tcrei_context" placeholder="e.g., 'Audience: non-technical SMB owners; Length: ~800 words…'"></textarea>
          <div class="chips">
            <span class="chip" onclick="insertChip('tcrei_context','Audience: {{audience}}')">Audience</span>
            <span class="chip" onclick="insertChip('tcrei_context','Length: {{length}}')">Length</span>
            <span class="chip" onclick="insertChip('tcrei_context','Constraints: avoid jargon; include 3 examples')">Constraints</span>
          </div>

          <!-- Really (References) -->
          <div class="section-title">Really (References)</div>
          <label for="tcrei_references">References or examples:</label>
          <textarea id="tcrei_references" placeholder="e.g., 'Use these URLs… or paste exemplar text'"></textarea>

          <!-- Inputs (Iterate) -->
          <div class="section-title">Inputs (Iterate)</div>
          <label for="tcrei_iterate">
            How should it improve/iterate?
            <span class="tooltip">
              <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
              <span class="tooltiptext">
                • Expand intro with story<br>
                • Make summary snappier<br>
                • Provide pros/cons then a recommendation<br>
              </span>
            </span>
          </label>
          <textarea id="tcrei_iterate" placeholder="e.g., 'Shorten by half; add CTA; remove redundancy'"></textarea>
          <div class="chips">
            <span class="chip" onclick="insertChip('tcrei_iterate','Critique for clarity and remove redundancy')">Critique clarity</span>
            <span class="chip" onclick="insertChip('tcrei_iterate','Add a clear call to action at the end')">Add CTA</span>
            <span class="chip" onclick="insertChip('tcrei_iterate','Provide both pros and cons, then conclude with a recommendation')">Pros/Cons + Rec</span>
          </div>

          <div class="checkbox-container">
            <input type="checkbox" id="tcrei_add_tags">
            <label for="tcrei_add_tags">Add XML-like tags to output (e.g., &lt;task&gt;)</label>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" onclick="generatePromptAndSave('tcrei')">Generate TCREI Prompt & Save</button>
            <button type="button" class="btn-outline btn-sm" onclick="makeABVariants()">A/B Variants</button>
            <button type="button" class="btn-outline btn-sm" onclick="randomiseField('tcrei_task','task')">Randomise Task</button>
          </div>
        </div>

        <!-- DESIGN (your existing fields stay; you can mirror preview later if you want) -->
        <div id="designMethod" class="method-section">
          <h2>DESIGN Method (Image Generation)</h2>
          <p>Using the DESIGN Method:</p>
          <ul>
            <li><strong>D</strong>escription</li><li><strong>E</strong>nvironment</li><li><strong>S</strong>tyle</li><li><strong>I</strong>llumination</li><li><strong>G</strong>radation</li><li><strong>N</strong>uances</li>
          </ul>
        <div class="section-title">Description (Subject & Action)</div>
        <label for="design_description">
          Core subject or action
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Subjects</strong><br>
              • Animal: cat, dog, owl, horse<br>
              • Person: child, traveller, knight, astronaut<br>
              • Object: vintage camera, broken clock, crystal goblet<br>
              • Creature: dragon, phoenix, alien<br>
              • Abstract: swirling energy, fractal geometry<br>
              <br>
              <strong>Actions</strong><br>
              • Running, leaping, floating, gazing<br>
              • Reading, painting, cooking, inventing<br>
              • Battling, defending, embracing, dancing<br>
              • Exploring, discovering, meditating<br>
              <br>
              <strong>Tips</strong><br>
              Combine subject + action for clarity:<br>
              – “A curious cat batting at a butterfly”<br>
              – “An astronaut planting a flag on Mars”<br>
              – “A knight kneeling before a stained-glass window”<br>
            </span>
          </span>
        </label>
        <textarea id="design_description" placeholder="e.g., 'A curious cat batting at a butterfly.'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_description','A curious cat batting at a butterfly')">Cat + butterfly</span>
          <span class="chip" onclick="insertChip('design_description','An astronaut planting a flag on Mars')">Astronaut + flag</span>
          <span class="chip" onclick="insertChip('design_description','A knight kneeling before a stained-glass window')">Knight + prayer</span>
          <span class="chip" onclick="insertChip('design_description','A phoenix bursting into flames mid-flight')">Phoenix</span>
          <span class="chip" onclick="insertChip('design_description','A child discovering a glowing crystal in a cave')">Crystal cave</span>
        </div>

        <div class="section-title">Environment (Setting & Background)</div>
        <label for="design_environment">
          Setting
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Natural settings</strong><br>
              • In an old, sun-dappled forest<br>
              • On a windswept desert dune<br>
              • Atop a snowy mountain peak<br>
              • Under the ocean, coral reef teeming with life<br>
              • In a misty swamp with glowing fungi<br>
              <br>
              <strong>Human-made settings</strong><br>
              • In an ancient library with towering shelves<br>
              • In a futuristic neon cityscape<br>
              • Inside a rustic cabin with fireplace<br>
              • On a bustling medieval marketplace<br>
              • In a ruined temple overgrown with vines<br>
              <br>
              <strong>Atmospheres</strong><br>
              • Dreamlike haze • Post-apocalyptic wasteland • Cozy interior • Majestic and grand • Minimalist blank space<br>
              <br>
              <strong>Tips</strong><br>
              Anchor the subject in space/time:<br>
              – “In an old, sun-dappled library”<br>
              – “On a spaceship drifting through Saturn’s rings”<br>
              – “At a neon-lit ramen stall in a rainy alley”<br>
            </span>
          </span>
        </label>
        <textarea id="design_environment" placeholder="e.g., 'In an old, sun-dappled library.'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_environment','In an old, sun-dappled library with towering bookshelves')">Library</span>
          <span class="chip" onclick="insertChip('design_environment','In a futuristic neon cityscape, rain-slick streets')">Cyberpunk city</span>
          <span class="chip" onclick="insertChip('design_environment','On a snowy mountain peak above the clouds')">Snowy peak</span>
          <span class="chip" onclick="insertChip('design_environment','Inside a rustic cabin with a glowing fireplace')">Rustic cabin</span>
          <span class="chip" onclick="insertChip('design_environment','At a neon-lit ramen stall in a rainy alley')">Ramen stall</span>
          <span class="chip" onclick="insertChip('design_environment','On a spaceship drifting through Saturn’s rings')">Spaceship</span>
        </div>


        <div class="section-title">Style (Artistic & Visual Aesthetic)</div>
        <label for="design_style">
          Style
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Common styles</strong><br>
              • Photorealistic, cinematic still<br>
              • Fine art oil painting (impasto)<br>
              • Watercolor illustration, loose washes<br>
              • Charcoal sketch, cross-hatching<br>
              • Line art, minimal ink<br>
              • Matte painting, concept art<br>
              • Anime keyframe, clean linework<br>
              • Ghibli-inspired soft fantasy<br>
              • Pixar-like 3D render<br>
              • Isometric, low-poly<br>
              • Pixel art, 16-bit<br>
              • Noir, high-contrast B/W<br>
              • Vaporwave, synthwave<br>
              • Cyberpunk neon<br>
              • Art Deco / Bauhaus<br>
              • Ukiyo-e woodblock print<br>
              • Surrealist (Magritte/Dalí)<br>
              • Impressionist (Monet/Vang Gogh vibe)<br>
              • Pop art, halftone dots<br>
              <br>
              <strong>Medium / surface</strong><br>
              • Oil on canvas • Gouache on textured paper • Ink on rice paper • Chalk on blackboard • Spray paint on concrete<br>
              <br>
              <strong>Reference artists (optional)</strong><br>
              • “in the style of …” *only if allowed by your tool* (otherwise say “inspired by ...”)<br>
            </span>
          </span>
        </label>
        <textarea id="design_style" placeholder="e.g., 'Photorealistic, cinematic still.' or 'Oil painting'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_style','Photorealistic, cinematic still')">Photorealistic</span>
          <span class="chip" onclick="insertChip('design_style','Fine art oil painting, impasto brushwork')">Oil painting</span>
          <span class="chip" onclick="insertChip('design_style','Watercolor illustration, loose washes')">Watercolor</span>
          <span class="chip" onclick="insertChip('design_style','Anime keyframe, clean linework')">Anime</span>
          <span class="chip" onclick="insertChip('design_style','Ukiyo-e woodblock print aesthetic')">Ukiyo-e</span>
          <span class="chip" onclick="insertChip('design_style','Isometric, low-poly render')">Isometric</span>
          <span class="chip" onclick="insertChip('design_style','Noir, high-contrast black & white')">Noir</span>
        </div>

        <div class="section-title">Illumination (Lighting & Time)</div>
        <label for="design_illumination">
          Lighting
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Natural light</strong><br>
              • Golden hour backlight, long soft shadows<br>
              • Blue hour ambient with city glow<br>
              • Overcast diffuse softbox light<br>
              • Harsh noon sun, high contrast<br>
              • Moonlit night, cool tones<br>
              • Volumetric god rays through fog<br>
              <br>
              <strong>Artificial light</strong><br>
              • Studio three-point lighting (key/fill/rim)<br>
              • Rembrandt lighting (triangle cheek highlight)<br>
              • Split lighting (dramatic halves)<br>
              • Neon signage spill, rim highlights<br>
              • Candlelit interior, warm pockets of light<br>
              • Firelight flicker, warm orange<br>
              <br>
              <strong>Time & atmosphere</strong><br>
              • Dawn pastel sky • Sunset pink/amber bounce • Stormy clouds with shafts of light • Hazy dust motes<br>
            </span>
          </span>
        </label>
        <textarea id="design_illumination" placeholder="e.g., 'Golden hour backlight'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_illumination','Golden hour backlight, long soft shadows')">Golden hour</span>
          <span class="chip" onclick="insertChip('design_illumination','Blue hour city glow, neon highlights')">Blue hour</span>
          <span class="chip" onclick="insertChip('design_illumination','Overcast diffuse softbox lighting')">Overcast soft</span>
          <span class="chip" onclick="insertChip('design_illumination','Studio three-point lighting (key, fill, rim)')">Studio 3-point</span>
          <span class="chip" onclick="insertChip('design_illumination','Candlelit interior, warm pools of light')">Candlelit</span>
          <span class="chip" onclick="insertChip('design_illumination','Volumetric god rays through dusty windows')">God rays</span>
        </div>
        <div class="section-title">Gradation (Quality & Detail)</div>
        <label for="design_gradation">
          Quality
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Resolution / fidelity</strong><br>
              • 8K, masterpiece, sharp focus • Ultra-real textures, micro-detail • HDR wide dynamic range<br>
              • Print-ready (≈300 DPI) • Film grain subtle<br>
              <br>
              <strong>Rendering hints</strong><br>
              • PBR materials, physically based rendering<br>
              • Global illumination, ray-traced reflections<br>
              • Subsurface scattering (skin) • Ambient occlusion<br>
              • Depth of field with creamy bokeh<br>
              <br>
              <strong>Lens & camera (optional)</strong><br>
              • 24mm wide • 50mm standard • 85mm portrait • Macro 1:1<br>
            </span>
          </span>
        </label>
        <textarea id="design_gradation" placeholder="e.g., '8K, masterpiece, sharp focus.'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_gradation','8K, masterpiece, sharp focus')">8K masterpiece</span>
          <span class="chip" onclick="insertChip('design_gradation','Ultra-real textures, micro-detail, HDR')">Ultra-real HDR</span>
          <span class="chip" onclick="insertChip('design_gradation','PBR materials, global illumination, ray-traced reflections')">PBR + GI + RT</span>
          <span class="chip" onclick="insertChip('design_gradation','Subsurface skin scattering, ambient occlusion')">SSS + AO</span>
          <span class="chip" onclick="insertChip('design_gradation','Shallow depth of field, creamy bokeh')">DOF + bokeh</span>
        </div>

        <div class="section-title">Nuances (Modifiers & Negative Prompts)</div>
        <label for="design_nuances">
          Nuances
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Camera & composition</strong><br>
              • Low angle hero shot (24mm) • High angle bird’s-eye • Over-the-shoulder framing<br>
              • Rule of thirds, subject off-center • Leading lines • Foreground framing (leaves/arches)<br>
              • Motion blur background, subject sharp • Dutch tilt for tension<br>
              <br>
              <strong>Stylistic modifiers</strong><br>
              • Weathered, patina • Bioluminescent accents • Misty, ethereal<br>
              • Minimalist • Maximalist • Symmetry / asymmetry<br>
              <br>
              <strong>Negative prompts (avoid)</strong><br>
              • Negative: blurry, out of focus, noise, watermark, text artifacts<br>
              • Negative: deformed anatomy, extra fingers, distorted faces<br>
              • Negative: over-saturated colors, banding, JPEG artifacts<br>
            </span>
          </span>
        </label>
        <textarea id="design_nuances" placeholder="e.g., 'Low angle hero shot; Negative: blurry, watermark'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_nuances','Low angle hero shot, 24mm lens')">Low-angle 24mm</span>
          <span class="chip" onclick="insertChip('design_nuances','Over-the-shoulder framing, shallow DOF')">OTS + DOF</span>
          <span class="chip" onclick="insertChip('design_nuances','Rule of thirds, subject off-center')">Rule of thirds</span>
          <span class="chip" onclick="insertChip('design_nuances','Motion blur background, subject sharp')">Motion blur</span>
          <span class="chip" onclick="insertChip('design_nuances','Negative: blurry, noise, watermark, text artifacts')">Neg: blur/noise/text</span>
          <span class="chip" onclick="insertChip('design_nuances','Negative: deformed anatomy, extra fingers, distorted faces')">Neg: anatomy</span>
        </div>

          <div class="section-title">Visual References / Examples</div>
          <label for="design_references">References / URLs</label>
          <textarea id="design_references" placeholder="e.g., 'Inspired by…; ref: https://…'"></textarea>

          <button type="button" onclick="generatePromptAndSave('design')">Generate DESIGN Prompt & Save</button>
        </div>
        <!-- AGENT (Research & Implement) -->
        <div id="agentMethod" class="method-section">
          <h2>Agent Mode (Research & Implement)</h2>
          <p>Build a browsable, source-cited, implementation-oriented prompt for an autonomous agent.</p>

          <div class="section-title">Objective</div>
          <label for="agent_objective">What do you want achieved?</label>
          <textarea id="agent_objective" placeholder="e.g., Implement membership renewal resend link in Woo admin..."></textarea>

          <div class="section-title">Success Criteria</div>
          <label for="agent_success">How will we measure success?</label>
          <textarea id="agent_success" placeholder="e.g., Link appears under 'Next Bill On', sends correct email template, logs action..."></textarea>

          <div class="section-title">Scope / Out of Scope</div>
          <label for="agent_scope">In scope (bullet list)</label>
          <textarea id="agent_scope" placeholder="- Add admin link\n- Trigger existing email template\n- Include nonce + capability checks"></textarea>

          <label for="agent_outofscope">Out of scope (bullet list)</label>
          <textarea id="agent_outofscope" placeholder="- New email templates\n- DB schema changes"></textarea>

          <div class="section-title">Constraints</div>
          <label for="agent_constraints">Perf, security, compliance, time/budget</label>
          <textarea id="agent_constraints" placeholder="- Follow WP nonces/escapes\n- No raw SQL without $wpdb->prepare\n- AEST logs only"></textarea>

          <div class="section-title">Environment Details</div>
          <label for="agent_env">Versions, plugin names, paths</label>
          <textarea id="agent_env" placeholder="PHP 8+, WP + Woo, Local by Flywheel (Win11), prod on Flywheel (NGINX). Plugin: /wp-content/plugins/oi-mods/ (single repo). TZ: Australia/Brisbane (AEST; no DST)."></textarea>

          <div class="section-title">Extra Vendor Docs (optional)</div>
          <label for="agent_extra_sources">Add domain-specific docs to prioritize</label>
          <textarea id="agent_extra_sources" placeholder="- Formidable Forms developer docs\n- Woo Memberships docs"></textarea>

          <button type="button" onclick="generatePromptAndSave('agent')">Generate Agent Prompt & Save</button>
        </div>

      </div>

      <!-- Side panel -->
      <aside class="side-panel">
        <h3>Final Prompt Preview</h3>
        <div class="preview-toolbar">
          <button class="btn-sm" onclick="copyPreview()">Copy (with tags)</button>
          <button class="btn-sm btn-outline" onclick="copyPreview(true)">Copy clean</button>
          <button class="btn-sm btn-outline" onclick="exportPrompt()">Export JSON</button>
          <label class="btn-sm btn-outline" style="cursor:pointer;">
            Import JSON <input type="file" id="importFile" accept="application/json" style="display:none" onchange="importPrompt(event)">
          </label>
        </div>
        <div id="livePreview" class="preview">Start typing to see a live preview…</div>

        <h3 style="margin-top:16px;">Quality Checks</h3>
        <div id="linter" class="meter"></div>

        <h3>Length & Tokens</h3>
        <div id="lengthInfo" class="meter"></div>

        <div style="margin-top:12px;">
          <span class="badge" id="autosaveStatus">Autosave: idle</span>
          <button class="btn-sm btn-outline" onclick="restoreDraft()">Restore draft</button>
          <button class="btn-sm btn-outline" onclick="clearDraft()">Clear draft</button>
        </div>
      </aside>
    </div>

    <hr>

    <h2>Current Session Prompts</h2>
    <div id="sessionPromptHistoryContainer">
      <p class="no-prompts-message">Prompts generated in this session will appear here. They’re saved to the database but will clear here on refresh.</p>
    </div>

    <hr>

    <h2>Search & Manage Saved Prompts</h2>
    <div class="search-controls">
      <div>
        <label for="searchPromptType">Filter by Type:</label>
        <select id="searchPromptType">
          <option value="All">All Types</option>
          <option value="tcrei">TCREI</option>
          <option value="design">DESIGN</option>
           <option value="agent">AGENT</option>
        </select>
      </div>

      <div>
        <label for="searchKeyword">Search Keyword:</label>
        <input type="text" id="searchKeyword" placeholder="Search by title or content...">
      </div>

      <div>
        <label for="searchSortBy">Sort By:</label>
        <select id="searchSortBy">
          <option value="created_at" selected>Created</option>
          <option value="title">Title</option>
          <option value="type">Type</option>
        </select>
      </div>

      <div>
        <label for="searchSortDir">Direction:</label>
        <select id="searchSortDir">
          <option value="desc" selected>Desc</option>
          <option value="asc">Asc</option>
        </select>
      </div>

      <div>
        <label for="searchMode">Search Mode:</label>
        <select id="searchMode" title="auto uses FULLTEXT if available, else LIKE">
          <option value="auto" selected>Smart (auto)</option>
          <option value="like">LIKE</option>
          <option value="fulltext">FULLTEXT</option>
        </select>
      </div>

      <div style="min-width: 160px;">
        <label for="includeDeleted">Include deleted</label>
        <input type="checkbox" id="includeDeleted" />
      </div>

      <button type="button" onclick="searchPrompts(1, true)">Search Prompts</button>
      <button type="button" onclick="listAllPrompts()">List All Prompts</button>
    </div>
    <div id="searchResultsContainer">
      <p class="no-prompts-message">Search results will appear here. Use "List All Prompts" to see all saved entries.</p>
    </div>

    <div class="pagination-controls">
      <button id="prevPageBtn" onclick="changePage(-1)" disabled>Previous</button>
      <span id="currentPageSpan">Page 1 of 1</span>
      <button id="nextPageBtn" onclick="changePage(1)" disabled>Next</button>
    </div>

    <button id="clearAllDbPrompts" class="clear-all-db-prompts" type="button" style="display:none;">Clear ALL Saved Prompts (from Database)</button>
  </div>

  <!-- Core logic (enhancements + your existing functions) -->
  <script>
    let sessionPromptCounter=0,lastRestoredPromptData=null,currentSearchPage=1,totalPages=1;
    const promptsPerPage=10;

    function showAlert(message,type='success'){const b=document.getElementById('alert-banner');const m=document.getElementById('alert-message');b.className='alert';b.classList.add(type);m.innerHTML=message;b.style.display='block';b.scrollIntoView({behavior:'smooth',block:'start'});setTimeout(()=>{b.style.display='none';},5000);}
    function normalizeInput(text){return (text||'').trim().replace(/\n{2,}/g,'\n');}
    function buildAgentObj() {
      if (document.getElementById('methodSelector').value !== 'agent') return { text: '' };

      const objective    = normalizeInput(document.getElementById('agent_objective').value);
      const success      = normalizeInput(document.getElementById('agent_success').value);
      const scope        = normalizeInput(document.getElementById('agent_scope').value);
      const outofscope   = normalizeInput(document.getElementById('agent_outofscope').value);
      const constraints  = normalizeInput(document.getElementById('agent_constraints').value);
      const env          = normalizeInput(document.getElementById('agent_env').value);
      const extraVendors = normalizeInput(document.getElementById('agent_extra_sources').value);

      // Source Priority block (append extra vendors if provided)
      const extraLine = extraVendors ? `\n6) ${extraVendors}\n` : '\n6) {{domain-specific vendor docs}}\n';
      const SOURCE_PRIORITY = 
    `SOURCE PRIORITY (examples to start with)
    1) WordPress Developer Resources & Plugin Handbook
    2) WooCommerce Docs & Developer Docs
    3) PHP Manual; MySQL Docs; MDN for front-end
    4) Flywheel Help/Docs (hosting specifics)
    5) OpenAI official docs when relevant${extraLine}(Avoid Wikipedia unless no primary sources exist.)`;

      const CONTEXT = 
    `CONTEXT
    - Stack: WordPress (custom plugin single-repo), WooCommerce, PHP 8+, MySQL, jQuery/Bootstrap. Local dev via Local by Flywheel (Windows 11); prod on Flywheel (NGINX); timezone: Australia/Brisbane (AEST; no DST).
    - Preferences: runnable code + clear placement instructions + concise reasoning bullets; prefer primary sources. Avoid Wikipedia unless no primary source is available.`;

      const TASK =
    `TASK
    - Objective: ${objective || '{{what to achieve}}'}
    - Success criteria: ${success || '{{measurable outcomes}}'}
    - Scope / Out of scope: ${(scope||'').trim() || '{{lists}}'}${outofscope ? `\n  (Out of scope)\n  ${outofscope}` : ''}
    - Constraints: ${constraints || '{{perf, security, compliance, time, budget}}'}
    - Environment details: ${env || '{{versions, plugin names, relevant paths}}'}`;

      const TOOLS_ACTIONS =
    `TOOLS & ACTIONS
    - You may browse the web, read/place files, and create artifacts. For high-impact changes (security, data loss risk), PAUSE and request confirmation before acting.
    - Prefer these source types, in order: vendor/official docs; standards bodies; original blog posts/release notes; well-established community docs. Provide inline citations and a short **Sources** section.`;

      const WORKFLOW =
    `WORKFLOW
    1) Clarify assumptions (≤5 bullets). Then outline a short plan (steps).
    2) Execute research with citations; compare at least 2 primary sources when applicable.
    3) Deliver artifacts:
      - Code (ready to paste) with exact file path and hooks/filters used
      - Any commands (WP-CLI, SQL, cURL) needed
      - Minimal test plan + rollback instructions
      - Changelog of files touched
    4) If blocked, present 2–3 options with trade-offs and your recommendation.
    5) Stop if credentials are required or an irreversible action is detected—ask for approval.`;

      const OUTPUT_QUALITY =
    `OUTPUT FORMAT
    - **Assumptions**
    - **Plan** (bullet list)
    - **Implementation** (code + where to place it)
    - **Tests** (how to verify)
    - **Rollback** (how to undo)
    - **Sources** (3–7 links, official docs first)

    QUALITY BARS
    - Security: sanitize/escape/nonce in WordPress; least privilege; avoid secrets in code.
    - Performance: O(n) where feasible; cache/indices when needed.
    - Accessibility: semantic HTML; color contrast; ARIA when relevant.
    - Observability: add concise logs around risky areas.

    CONFIRMATION BREAKPOINTS
    - Any DB schema change, htaccess/NGINX update, auth/session changes, or writes outside plugin directory.`;

      const header = 
    `ROLE & GOAL
    You are an autonomous engineering/research agent assisting Joe (casual tone). Your goal is to produce working, documented outputs and cite trustworthy sources.`;

      const text = [
        header,
        CONTEXT,
        TASK,
        TOOLS_ACTIONS,
        SOURCE_PRIORITY,
        WORKFLOW,
        OUTPUT_QUALITY
      ].join('\n\n');

      return {
        text,
        objective, success, scope, outofscope, constraints, env, extraVendors
      };
    }

    // ---- AGENT linter ----
    function lintAgent(obj) {
      const issues = [];
      if (!obj.objective?.trim())     issues.push('No objective.');
      if (!obj.success?.trim())       issues.push('No success criteria.');
      if (!obj.scope?.trim() && !obj.outofscope?.trim()) issues.push('No scope / out-of-scope.');
      if (!obj.env?.trim())           issues.push('No environment details.');
      if (/\b(nice|cool|good|things|stuff)\b/i.test(obj.text)) issues.push('Ambiguous wording detected — be precise.');
      return issues;
    }
    function clearFormFields(){document.querySelectorAll('textarea').forEach(t=>t.value='');document.getElementById('tcrei_add_tags').checked=false;lastRestoredPromptData=null;renderPreview();}

    function deepEqual(a,b){if(a===b)return true;if(a==null||typeof a!='object'||b==null||typeof b!='object')return false;const ka=Object.keys(a),kb=Object.keys(b);if(ka.length!==kb.length)return false;for(const k of ka){if(!kb.includes(k)||!deepEqual(a[k],b[k]))return false}return true}

    async function generatePromptAndSave(method){
      let combinedPrompt=''; let promptData={method};
      if(method==='tcrei'){ /* existing TCREI block stays as-is */ }
      else if(method==='design'){ /* existing DESIGN block stays as-is */ }
      else if(method==='agent'){
        // Collect + build
        const obj = buildAgentObj();
        // basic guard: require at least objective
        if (!obj.objective?.trim()) { showAlert('Please add an Objective for Agent Mode.','warning'); return; }
        combinedPrompt = obj.text;
        Object.assign(promptData, {
          objective: obj.objective,
          success: obj.success,
          scope: obj.scope,
          outofscope: obj.outofscope,
          constraints: obj.constraints,
          env: obj.env,
          extraVendors: obj.extraVendors
        });
      }

      if(combinedPrompt){
        let saveToDB=true, sessionPromptTitle='', isNew=true;
        if(lastRestoredPromptData && deepEqual(promptData,lastRestoredPromptData)){
          showAlert('No changes detected. Prompt not saved as a new copy.','info');
          saveToDB=false; isNew=false; sessionPromptTitle=`Loaded Prompt (No Changes) ${++sessionPromptCounter}`;
        }
        if(saveToDB){
          const date=new Date();
          const dbSaveTitle=`${method.toUpperCase()} Prompt - ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
          const saved=await savePromptToDB(dbSaveTitle,combinedPrompt,promptData);
          if(saved){
            sessionPromptTitle=`${method.toUpperCase()} Session Prompt ${++sessionPromptCounter} - ${date.toLocaleTimeString()}`;
            addPromptToAccordion(sessionPromptTitle,combinedPrompt,promptData,saved.id,'#sessionPromptHistoryContainer');
            document.querySelector('#sessionPromptHistoryContainer .no-prompts-message')?.remove();
          } else { sessionPromptTitle=''; }
        }
        if(sessionPromptTitle && !isNew){
          addPromptToAccordion(sessionPromptTitle,combinedPrompt,promptData,'session-'+sessionPromptCounter,'#sessionPromptHistoryContainer');
          document.querySelector('#sessionPromptHistoryContainer .no-prompts-message')?.remove();
        }
        renderPreview();
      }
    }

    async function savePromptToDB(title,generated_prompt,prompt_data){
      try{
        const res=await fetch('php/save_prompt.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:prompt_data.method,title,generated_prompt,prompt_data})});
        if(!res.ok){const e=await res.json();throw new Error(e.error||'Failed to save')}
        const result=await res.json();showAlert(result.message,'success');return result.prompt;
      }catch(err){console.error(err);showAlert(`Error saving prompt: ${err.message}`,'error');return null;}
    }

    async function deletePrompt(id){
      if(!confirm('Delete this prompt from the database?'))return;
      try{
        const res=await fetch('php/delete_prompt.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
        if(!res.ok){const e=await res.json();throw new Error(e.error||'Failed to delete')}
        const result=await res.json();showAlert(result.message,'success');searchPrompts(currentSearchPage);
      }catch(err){console.error(err);showAlert(`Error deleting prompt: ${err.message}`,'error');}
    }

    async function searchPrompts(page = 1, isSearchButtonClicked = false) {
      const searchType   = document.getElementById('searchPromptType').value;
      const searchKeyword= document.getElementById('searchKeyword').value;

      // NEW controls
      const sortBy   = document.getElementById('searchSortBy').value || 'created_at';
      const sortDir  = document.getElementById('searchSortDir').value || 'desc';
      const mode     = document.getElementById('searchMode').value || 'auto';
      const includeDeleted = document.getElementById('includeDeleted').checked ? 1 : 0;

      currentSearchPage = page;

      // Validation (only when user explicitly clicks Search)
      if (isSearchButtonClicked && searchKeyword.trim() === '' && searchType === 'All') {
        showAlert("Please enter a search keyword or select a specific prompt type.", 'warning');
        document.getElementById('searchResultsContainer').innerHTML =
          '<p class="no-prompts-message">Search results will appear here. Use "List All Prompts" to see all saved entries.</p>';
        document.getElementById('clearAllDbPrompts').style.display = 'none';
        updatePaginationControls(0, 0);
        return;
      }

      const searchResultsContainer = document.getElementById('searchResultsContainer');
      searchResultsContainer.innerHTML = '<p class="no-prompts-message">Searching...</p>';
      document.getElementById('clearAllDbPrompts').style.display = 'none';

      const queryParams = new URLSearchParams({
        page: currentSearchPage,
        limit: promptsPerPage,
        sort_by: sortBy,
        sort_dir: sortDir,
        search_mode: mode
      });

      if (searchType !== 'All') {
        queryParams.append('type', searchType);
      }
      if (searchKeyword.trim() !== '') {
        queryParams.append('keyword', searchKeyword.trim());
      }
      if (includeDeleted) {
        queryParams.append('include_deleted', '1'); // backend auto-ignores if column not present
      }

      try {
        const response = await fetch(`php/search_prompts.php?${queryParams.toString()}`);
        if (!response.ok) throw new Error('Failed to fetch search results');

        const result = await response.json();

        searchResultsContainer.innerHTML = '';

        if (!result.prompts || result.prompts.length === 0) {
          searchResultsContainer.innerHTML = '<p class="no-prompts-message">No matching prompts found.</p>';
          document.getElementById('clearAllDbPrompts').style.display = 'none';
        } else {
          result.prompts.forEach(prompt => {
            addPromptToAccordion(prompt.title, prompt.generated_prompt, prompt.prompt_data, prompt.id, '#searchResultsContainer');
          });
          document.getElementById('clearAllDbPrompts').style.display = 'block';
        }

        totalPages = result.total_pages || 1;
        currentSearchPage = result.current_page || 1;
        updatePaginationControls();

      } catch (error) {
        console.error('Error searching prompts:', error);
        searchResultsContainer.innerHTML =
          '<p class="no-prompts-message" style="color:red;">Error searching prompts. Please check the server connection and PHP scripts.</p>';
        showAlert(`Error searching prompts: ${error.message}`, 'error');
        updatePaginationControls(0, 0);
      }
    }

    function restorePrompt(data){
      clearFormFields(); lastRestoredPromptData=data;
      const method=data.method; document.getElementById('methodSelector').value=method; showMethodFields();
      if(method==='tcrei'){
        document.getElementById('tcrei_task').value=data.task||'';
        document.getElementById('tcrei_format').value=data.format||'';
        document.getElementById('tcrei_context').value=data.context||'';
        document.getElementById('tcrei_references').value=data.references||'';
        document.getElementById('tcrei_iterate').value=data.iterate||'';
        document.getElementById('tcrei_add_tags').checked=!!data.addTags;
      }else{
        document.getElementById('design_description').value=data.description||'';
        document.getElementById('design_environment').value=data.environment||'';
        document.getElementById('design_style').value=data.style||'';
        document.getElementById('design_illumination').value=data.illumination||'';
        document.getElementById('design_gradation').value=data.gradation||'';
        document.getElementById('design_nuances').value=data.nuances||'';
        document.getElementById('design_references').value=data.references||'';
      }
      renderPreview(); showAlert('Prompt loaded for editing.','success'); window.scrollTo({top:0,behavior:'smooth'});
    }
    function showMethodFields() {
        const method = document.getElementById('methodSelector')?.value || 'tcrei';
        const map = {
          tcrei:  'tcreiMethod',
          design: 'designMethod',
          agent:  'agentMethod' // safe even if you haven't added Agent yet
        };

        ['tcreiMethod','designMethod','agentMethod'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.classList.toggle('active', id === map[method]);
        });

        // Your existing preview function already exists; call it
        if (typeof renderPreview === 'function') renderPreview();
      }
    function addPromptToAccordion(title,text,data,id,containerSel){
      const container=document.querySelector(containerSel);
      const item=document.createElement('div'); item.classList.add('accordion-item'); item.dataset.prompt=JSON.stringify(data); item.dataset.uniqueId=id;
      const btn=document.createElement('button'); btn.classList.add('accordion-button'); btn.textContent=title;
      btn.onclick=function(){ this.classList.toggle('active'); const panel=this.nextElementSibling;
        if(panel.classList.contains('active')){ panel.classList.remove('active'); panel.style.maxHeight=null; }
        else{ panel.classList.add('active'); panel.style.maxHeight=(panel.scrollHeight+80)+'px'; }
      };
      const panel=document.createElement('div'); panel.classList.add('accordion-panel');
      const pre=document.createElement('pre'); pre.textContent=text;
      const bg=document.createElement('div'); bg.classList.add('button-group');
      const copyBtn=document.createElement('button'); copyBtn.classList.add('copy-button'); copyBtn.textContent='Copy';
      copyBtn.onclick=(e)=>{e.stopPropagation(); copyToClipboard(text,copyBtn);};
      const restoreBtn=document.createElement('button'); restoreBtn.classList.add('load-button'); restoreBtn.textContent='Load for Editing';
      restoreBtn.onclick=(e)=>{e.stopPropagation(); restorePrompt(data);};
      bg.appendChild(copyBtn); bg.appendChild(restoreBtn);
      if(containerSel==='#searchResultsContainer'){const del=document.createElement('button'); del.classList.add('delete-button'); del.textContent='Delete'; del.onclick=(e)=>{e.stopPropagation(); deletePrompt(id);}; bg.appendChild(del);}
      panel.appendChild(pre); panel.appendChild(bg); item.appendChild(btn); item.appendChild(panel); container.prepend(item);
      if(containerSel==='#sessionPromptHistoryContainer'){ btn.click(); item.scrollIntoView({behavior:'smooth',block:'end'}); }
    }

    function copyToClipboard(text,btn){ if(!text){showAlert('No prompt to copy.','warning');return;}
      const ta=document.createElement('textarea'); ta.value=text; ta.style.position='absolute'; ta.style.left='-9999px'; document.body.appendChild(ta);
      const original=btn?.textContent||'Copy';
      try{ ta.select(); document.execCommand('copy'); if(btn){btn.textContent='Copied!'; setTimeout(()=>btn.textContent=original,2000);} showAlert('Prompt copied to clipboard!','success');}
      catch(err){console.error(err);showAlert('Failed to copy.','error');}
      finally{document.body.removeChild(ta);}
    }

    function listAllPrompts() {
      document.getElementById('searchPromptType').value = 'All';
      document.getElementById('searchKeyword').value = '';
      document.getElementById('searchSortBy').value = 'created_at';
      document.getElementById('searchSortDir').value = 'desc';
      document.getElementById('searchMode').value = 'auto';
      document.getElementById('includeDeleted').checked = false;

      searchPrompts(1, false);
    }
    function changePage(d){const p=currentSearchPage+d; if(p>=1&&p<=totalPages){searchPrompts(p,true);}}
    function updatePaginationControls(cur=currentSearchPage,tot=totalPages){document.getElementById('currentPageSpan').textContent=`Page ${cur} of ${tot}`;document.getElementById('prevPageBtn').disabled=(cur===1);document.getElementById('nextPageBtn').disabled=(cur===tot||tot===0);}

    document.getElementById('clearAllDbPrompts').onclick=async function(){
      if(confirm('Clear ALL saved prompts from the database?')){ try{
        const res=await fetch('php/clear_all_prompts.php',{method:'POST',headers:{'Content-Type':'application/json'}});
        if(!res.ok){const e=await res.json();throw new Error(e.error||'Failed to clear');}
        const result=await res.json(); showAlert(result.message,'success'); listAllPrompts();
      }catch(err){console.error(err);showAlert(`Error: ${err.message}`,'error');}}
    };

    // ---------- Enhancements: chips, presets, variables, linter, tokens, preview, autosave, A/B, import/export, shortcuts ----------
    function insertAtCursor(id,text){const ta=document.getElementById(id); if(!ta) return; const s=ta.selectionStart??ta.value.length; const e=ta.selectionEnd??ta.value.length;
      ta.value = ta.value.slice(0,s) + (ta.value && s>0 && text && !text.startsWith('\n') ? '\n'+text : text) + ta.value.slice(e);
      ta.focus(); const pos=(ta.value.length); ta.selectionStart=ta.selectionEnd=pos; renderPreview(); scheduleAutosave();
    }
    function insertChip(targetId,text){insertAtCursor(targetId,text);}
    function taHasText(id){return ((document.getElementById(id)?.value)||'').trim().length>0;}

    const PRESETS={
      blog:{task:"Write a blog post explaining {{topic}} to {{audience}}.",format:"Formatted in Markdown. Use headings, short paragraphs, and bullet lists where helpful.",context:"Tone: {{tone}}. Length: {{length}}. Include 3 real-world examples and a brief conclusion.",references:"",iterate:"Critique for clarity, remove redundancy, add a concise summary at the end."},
      product:{task:"Create a compelling product description for {{topic}}.",format:"Markdown with intro, bullet features, and benefits section.",context:"Audience: {{audience}}. Tone: {{tone}}. Length: {{length}}.",references:"Use brand style guide where applicable.",iterate:"Tighten copy; emphasise benefits; add a persuasive CTA."},
      email:{task:"Write an email campaign introducing {{topic}} to {{audience}}.",format:"Subject + preview + body (short paragraphs + bullets).",context:"Tone: {{tone}}. Keep it concise. One strong CTA.",references:"",iterate:"A/B test two subject lines and two CTAs."},
      bug:{task:"Draft a clear bug report.",format:"Sections: Summary, Steps, Expected, Actual, Environment, Screenshots.",context:"Audience: engineering. Be precise; avoid ambiguity.",references:"",iterate:"Ensure steps are minimal yet reproducible."}
    };
    function applyTemplate(k){if(!k||!PRESETS[k])return; const p=PRESETS[k];
      document.getElementById('tcrei_task').value=p.task; document.getElementById('tcrei_format').value=p.format; document.getElementById('tcrei_context').value=p.context;
      document.getElementById('tcrei_references').value=p.references; document.getElementById('tcrei_iterate').value=p.iterate; renderPreview(); scheduleAutosave();
    }

    function withVariables(text){
      const rep={'{{audience}}':document.getElementById('varAudience').value||'',
                 '{{tone}}':document.getElementById('varTone').value||'',
                 '{{length}}':document.getElementById('varLength').value||'',
                 '{{topic}}':'your topic'};
      return Object.keys(rep).reduce((acc,k)=>acc.split(k).join(rep[k]),text||'');
    }

    function lintPrompt(obj){
      const issues=[]; const t=[obj.task,obj.format,obj.context,obj.references,obj.iterate].filter(Boolean).join(' ');
      if(!obj.task?.trim()) issues.push('No task provided.');
      if(!/Audience:/i.test(obj.context||'') && !/{{audience}}/.test(t)) issues.push('No audience specified.');
      if(!/Length:/i.test(obj.context||'') && !/{{length}}/.test(t)) issues.push('No length guidance.');
      if((t.match(/\b(very|really|stuff|things)\b/gi)||[]).length>3) issues.push('Ambiguous words detected (very/really/stuff/things).');
      if((t.match(/\band also\b/gi)||[]).length>0) issues.push('Redundant phrase: "and also".');
      return issues;
    }

    function estimateTokens(s){const chars=(s||'').length; const words=(s||'').trim().split(/\s+/).filter(Boolean).length; const a=Math.ceil(chars/4), b=Math.ceil(words/0.75); return Math.round((a+b)/2);}

    function buildPromptObj(){
      if(document.getElementById('methodSelector').value!=='tcrei') return {text:''};
      const addTags=document.getElementById('tcrei_add_tags').checked;
      const mode=document.getElementById('modeSelector').value;
      let task=withVariables(normalizeInput(document.getElementById('tcrei_task').value));
      let format=withVariables(normalizeInput(document.getElementById('tcrei_format').value));
      let context=withVariables(normalizeInput(document.getElementById('tcrei_context').value));
      let references=withVariables(normalizeInput(document.getElementById('tcrei_references').value));
      let iterate=withVariables(normalizeInput(document.getElementById('tcrei_iterate').value));
      if(iterate){iterate=`Before finalising, critique your own draft against these criteria, then revise:\n${iterate}`;}
      let modeHint=''; if(mode==='concise')modeHint='Please keep the response concise and to the point.'; if(mode==='creative')modeHint='Embrace creativity and original turns of phrase.'; if(mode==='factual')modeHint='Be strictly factual and cite sources where possible.';
      if(addTags){
        const blocks=[]; if(task)blocks.push(`<task>${task}</task>`); if(format)blocks.push(`<format>${format}</format>`); if(context)blocks.push(`<context>${context}</context>`); if(references)blocks.push(`<references>${references}</references>`); if(iterate)blocks.push(`<revise>${iterate}</revise>`); if(modeHint)blocks.push(`<mode>${modeHint}</mode>`);
        return {addTags:true,text:blocks.join('\n'),task,format,context,references,iterate};
      }else{
        const parts=[]; if(task)parts.push(task); if(format)parts.push(format); if(context)parts.push(context); if(references)parts.push(references); if(iterate)parts.push(`Revise with:\n${iterate}`); if(modeHint)parts.push(modeHint);
        return {addTags:false,text:parts.join(' '),task,format,context,references,iterate};
      }
    }
 function renderPreview() {
    const live = document.getElementById('livePreview');
    const lint = document.getElementById('linter');
    const len  = document.getElementById('lengthInfo');
    const method = document.getElementById('methodSelector').value;

    const h3s = document.querySelectorAll('.side-panel h3');
    if (h3s[0]) {
      h3s[0].textContent =
        method === 'design' ? 'Final Prompt Preview (DESIGN)' :
        method === 'agent'  ? 'Final Prompt Preview (AGENT)'  :
                              'Final Prompt Preview (TCREI)';
    }

    let obj = { text: '' }, issues = [];
    if (method === 'tcrei') {
      obj = buildPromptObj();
      issues = lintPrompt(obj);
    } else if (method === 'design') {
      obj = buildDesignObj();
      issues = lintDesign(obj);
    } else if (method === 'agent') {
      obj = buildAgentObj();
      issues = lintAgent(obj);
    }

    live.textContent = obj.text || (method === 'design'
      ? 'Start typing to see a live preview for DESIGN…'
      : method === 'agent'
        ? 'Start typing to see a live preview for AGENT…'
        : 'Start typing to see a live preview for TCREI…');

    lint.innerHTML = issues.length ? ('⚠️ ' + issues.join('<br>')) : '✔️ Looks good';

    const tokens = estimateTokens(obj.text);
    const chars  = obj.text.length;
    const words  = obj.text.trim() ? obj.text.trim().split(/\s+/).length : 0;
    const warn   = tokens > 3500 ? ' — near/over typical 4K limit' : '';
    len.innerHTML = `Chars: ${chars} • Words: ${words} • Est. tokens: ${tokens}${warn}`;
  }
    function makeABVariants(){
      const base=buildPromptObj(); if(!base.text.trim()){showAlert('Nothing to variant — fill some fields first.','warning');return;}
      const A=base.text.replace(/Tone:[^\n]+/i,'Tone: friendly and concise');
      const B=base.text.replace(/Tone:[^\n]+/i,'Tone: persuasive and energetic');
      addPromptToAccordion('Variant A',A,{method:'tcrei',variant:'A'},'ab-A-'+Date.now(),'#sessionPromptHistoryContainer');
      addPromptToAccordion('Variant B',B,{method:'tcrei',variant:'B'},'ab-B-'+Date.now(),'#sessionPromptHistoryContainer');
      showAlert('Generated A/B variants in session history.','success');
    }

    const RANDOM_SETS={task:[
      'Write a blog post explaining {{topic}} to {{audience}}.',
      'Draft a social post series (5 posts) on {{topic}}.',
      'Summarise a long article into bullet points for {{audience}}.',
      'Create a how-to guide for {{topic}} with steps.'
    ]};
    function randomiseField(id,key){const arr=RANDOM_SETS[key]||[]; if(!arr.length)return; const choice=arr[Math.floor(Math.random()*arr.length)]; document.getElementById(id).value=choice; renderPreview(); scheduleAutosave();}

    const DRAFT_KEY='prompt_draft_v1'; let autosaveTimer=null;
    function scheduleAutosave(){const b=document.getElementById('autosaveStatus'); if(b) b.textContent='Autosave: typing…'; clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveDraft,600);}
    function currentPromptData(){
      const method = document.getElementById('methodSelector').value;
      if (method === 'tcrei') {
        return {
          method,
          task:document.getElementById('tcrei_task').value,
          format:document.getElementById('tcrei_format').value,
          context:document.getElementById('tcrei_context').value,
          references:document.getElementById('tcrei_references').value,
          iterate:document.getElementById('tcrei_iterate').value,
          addTags:document.getElementById('tcrei_add_tags').checked,
          vars:{
            audience:document.getElementById('varAudience').value,
            tone:document.getElementById('varTone').value,
            length:document.getElementById('varLength').value
          },
          mode:document.getElementById('modeSelector').value
        };
      } else if (method === 'design') {
        return {
          method,
          description:document.getElementById('design_description').value,
          environment:document.getElementById('design_environment').value,
          style:document.getElementById('design_style').value,
          illumination:document.getElementById('design_illumination').value,
          gradation:document.getElementById('design_gradation').value,
          nuances:document.getElementById('design_nuances').value,
          references:document.getElementById('design_references').value
        };
      } else if (method === 'agent') {
        return {
          method,
          objective:document.getElementById('agent_objective').value,
          success:document.getElementById('agent_success').value,
          scope:document.getElementById('agent_scope').value,
          outofscope:document.getElementById('agent_outofscope').value,
          constraints:document.getElementById('agent_constraints').value,
          env:document.getElementById('agent_env').value,
          extraVendors:document.getElementById('agent_extra_sources').value
        };
      }
      return { method };
    }

    // Add the agent IDs to the listeners registration array:
    [
      'tcrei_task','tcrei_format','tcrei_context','tcrei_references','tcrei_iterate','tcrei_add_tags',
      'design_description','design_environment','design_style','design_illumination','design_gradation','design_nuances','design_references',
      // AGENT fields:
      'agent_objective','agent_success','agent_scope','agent_outofscope','agent_constraints','agent_env','agent_extra_sources',
      // shared
      'varAudience','varTone','varLength','modeSelector','methodSelector'
    ].forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      const ev=(id==='tcrei_add_tags'||id==='methodSelector'||id==='modeSelector')?'change':'input';
      el.addEventListener(ev,()=>{renderPreview(); scheduleAutosave();});
    });    
    function saveDraft(){localStorage.setItem(DRAFT_KEY,JSON.stringify(currentPromptData())); const b=document.getElementById('autosaveStatus'); if(b) b.textContent='Autosave: saved';}
    function restoreDraft(){const raw=localStorage.getItem(DRAFT_KEY); if(!raw){showAlert('No draft found.','info');return;} const d=JSON.parse(raw);
      if(d.method==='tcrei'){document.getElementById('tcrei_task').value=d.task||'';document.getElementById('tcrei_format').value=d.format||'';document.getElementById('tcrei_context').value=d.context||'';document.getElementById('tcrei_references').value=d.references||'';document.getElementById('tcrei_iterate').value=d.iterate||'';document.getElementById('tcrei_add_tags').checked=!!d.addTags;document.getElementById('varAudience').value=d.vars?.audience||'';document.getElementById('varTone').value=d.vars?.tone||'';document.getElementById('varLength').value=d.vars?.length||'';document.getElementById('modeSelector').value=d.mode||'';renderPreview();showAlert('Draft restored.','success');}}
    function clearDraft(){localStorage.removeItem(DRAFT_KEY); const b=document.getElementById('autosaveStatus'); if(b) b.textContent='Autosave: cleared';}
    [
      'tcrei_task','tcrei_format','tcrei_context','tcrei_references','tcrei_iterate','tcrei_add_tags',
      'design_description','design_environment','design_style','design_illumination','design_gradation','design_nuances','design_references',
      'varAudience','varTone','varLength','modeSelector','methodSelector'
    ].forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      const ev=(id==='tcrei_add_tags'||id==='methodSelector'||id==='modeSelector')?'change':'input';
      el.addEventListener(ev,()=>{renderPreview(); scheduleAutosave();});
    });
    function copyPreview(clean=false){
      const obj = buildActiveObj();
      const text = clean ? (obj.text||'').replace(/<\/?[^>]+(>|$)/g,'') : (obj.text||'');
      copyToClipboard(text,{textContent:'Copied'});
    }
    function exportPrompt(){const data=currentPromptData(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`prompt-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);}
    function importPrompt(e){const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{try{const d=JSON.parse(ev.target.result); if(d.method!=='tcrei') throw new Error('Not a TCREI prompt file.');
      document.getElementById('tcrei_task').value=d.task||'';document.getElementById('tcrei_format').value=d.format||'';document.getElementById('tcrei_context').value=d.context||'';document.getElementById('tcrei_references').value=d.references||'';document.getElementById('tcrei_iterate').value=d.iterate||'';document.getElementById('tcrei_add_tags').checked=!!d.addTags;document.getElementById('varAudience').value=d.vars?.audience||'';document.getElementById('varTone').value=d.vars?.tone||'';document.getElementById('varLength').value=d.vars?.length||'';document.getElementById('modeSelector').value=d.mode||''; renderPreview(); scheduleAutosave(); showAlert('Prompt imported.','success');}
      catch(err){showAlert('Import failed: '+err.message,'error');}}; r.readAsText(f);}

    document.addEventListener('keydown',e=>{const cmd=e.metaKey||e.ctrlKey; if(!cmd)return; if(e.key.toLowerCase()==='enter'){e.preventDefault(); generatePromptAndSave('tcrei');} if(e.key.toLowerCase()==='k'){e.preventDefault(); clearFormFields(); renderPreview();} if(e.key==='/'){e.preventDefault(); document.querySelectorAll('.tooltiptext').forEach(tt=>{tt.style.visibility=(tt.style.visibility==='visible')?'hidden':'visible'; tt.style.opacity=(tt.style.opacity==='1')?'0':'1';});}});

        document.addEventListener('DOMContentLoaded', () => {
          showMethodFields();
          document.getElementById('searchResultsContainer').innerHTML =
            '<p class="no-prompts-message">Search results will appear here. Use "List All Prompts" to see all saved entries.</p>';
          document.getElementById('clearAllDbPrompts').style.display = 'none';
          updatePaginationControls();

          // OPTIONAL: restore prior search preferences
          const prefs = JSON.parse(localStorage.getItem('search_prefs') || '{}');
          if (prefs.type)  document.getElementById('searchPromptType').value = prefs.type;
          if (prefs.kw)    document.getElementById('searchKeyword').value   = prefs.kw;
          if (prefs.by)    document.getElementById('searchSortBy').value    = prefs.by;
          if (prefs.dir)   document.getElementById('searchSortDir').value   = prefs.dir;
          if (prefs.mode)  document.getElementById('searchMode').value      = prefs.mode;
          if (prefs.del)   document.getElementById('includeDeleted').checked = !!prefs.del;

          // Save prefs whenever controls change
          ['searchPromptType','searchKeyword','searchSortBy','searchSortDir','searchMode','includeDeleted']
            .forEach(id => {
              const el = document.getElementById(id);
              if (!el) return;
              el.addEventListener('change', () => {
                localStorage.setItem('search_prefs', JSON.stringify({
                  type: document.getElementById('searchPromptType').value,
                  kw:   document.getElementById('searchKeyword').value,
                  by:   document.getElementById('searchSortBy').value,
                  dir:  document.getElementById('searchSortDir').value,
                  mode: document.getElementById('searchMode').value,
                  del:  document.getElementById('includeDeleted').checked ? 1 : 0
                }));
              });
            });
        });

    // --- DESIGN builder ---
    function buildDesignObj() {
      if (document.getElementById('methodSelector').value !== 'design') return { text: '' };

      const description = normalizeInput(document.getElementById('design_description').value);
      const environment = normalizeInput(document.getElementById('design_environment').value);
      const style       = normalizeInput(document.getElementById('design_style').value);
      const illumination= normalizeInput(document.getElementById('design_illumination').value);
      const gradation   = normalizeInput(document.getElementById('design_gradation').value);
      const nuances     = normalizeInput(document.getElementById('design_nuances').value);
      const references  = normalizeInput(document.getElementById('design_references').value);

      const parts = [];
      if (description)  parts.push(description);
      if (environment)  parts.push(environment);
      if (style)        parts.push(style);
      if (illumination) parts.push(illumination);
      if (gradation)    parts.push(gradation);
      if (nuances)      parts.push(nuances);
      if (references)   parts.push(references);

      return {
        text: parts.join(' '),
        description, environment, style, illumination, gradation, nuances, references
      };
    }

    // --- DESIGN linter ---
    function lintDesign(obj) {
      const issues = [];
      const t = [
        obj.description, obj.environment, obj.style,
        obj.illumination, obj.gradation, obj.nuances, obj.references
      ].filter(Boolean).join(' ');

      if (!obj.description?.trim()) issues.push('No description (subject & action).');
      if (!obj.environment?.trim()) issues.push('No environment/setting specified.');
      if (!obj.style?.trim())       issues.push('No artistic style/aesthetic specified.');
      if (!obj.illumination?.trim())issues.push('No illumination/time-of-day specified.');
      if (!/negative|avoid/i.test(obj.nuances||'')) {
        issues.push('No negative prompts (e.g., “Negative: blurry, watermark, deformed”).');
      }

      // Soft suggestions:
      if (!/(low angle|high angle|bird|over[- ]the[- ]shoulder|tilt|lens|mm|macro|wide|tele|close[- ]up|rule of thirds)/i.test(t)) {
        issues.push('No camera/framing hints (optional: lens, angle, composition).');
      }
      if (/\b(nice|cool|good|thing|stuff)\b/i.test(t)) {
        issues.push('Ambiguous words detected (nice/cool/good/stuff). Be precise.');
      }
      return issues;
    }

    // Build whichever method is active
    function buildActiveObj() {
      const method = document.getElementById('methodSelector').value;
      if (method === 'tcrei')  return buildPromptObj();
      if (method === 'design') return buildDesignObj();
      if (method === 'agent')  return buildAgentObj();
      return { text: '' };
    }
    function toggleTemplateVisibility() {
      const method = document.getElementById('methodSelector')?.value || 'tcrei';
      const templateControl = document.getElementById('templatePreset').parentElement; 
      // assumes the <select> and its <label> are wrapped together inside the inline-controls

      if (method === 'tcrei') {
        templateControl.style.display = 'inline';
      } else {
        templateControl.style.display = 'none';
      }
    }

    // call on method change
    document.getElementById('methodSelector').addEventListener('change', () => {
      showMethodFields();
      toggleTemplateVisibility();
    });

    // call once on load
    document.addEventListener('DOMContentLoaded', toggleTemplateVisibility);
  </script>
</body>
</html>
