<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="genAI.png" rel="icon" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Gen AI Prompt Constructor</title>
  <style>
    body{font-family:Arial, sans-serif;margin:20px;background:#f4f4f4;color:#333}
    .container{max-width:1100px;margin:0 auto;background:#fff;padding:30px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.1)}
    h1,h2{color:#0056b3}
    label{display:block;margin-bottom:8px;font-weight:bold}
    textarea,select,input[type="text"]{width:100%;padding:10px;margin-bottom:20px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;min-height:40px;resize:vertical}
    textarea{min-height:100px}
    select{height:40px;background:#f8f8f8}
    button{background:#007bff;color:#fff;padding:12px 20px;border:none;border-radius:4px;cursor:pointer;font-size:16px;transition:background .3s;margin-top:10px}
    button:hover{background:#0056b3}
    .section-title{margin-bottom:15px;font-size:1.2em;color:#555;padding-top:10px;border-top:1px solid #eee;margin-top:20px}
    .method-section{display:none}
    .method-section.active{display:block}
    ul{margin-bottom:20px;padding-left:20px}
    ul li{margin-bottom:5px}

    /* Alerts */
    .alert{padding:20px;margin-bottom:20px;border:1px solid transparent;border-radius:4px;position:relative;opacity:1;transition:opacity .6s}
    .alert.success{background:#d4edda;color:#155724;border-color:#c3e6cb}
    .alert.warning{background:#fff3cd;color:#856404;border-color:#ffeeba}
    .alert.error{background:#f8d7da;color:#721c24;border-color:#f5c6cb}
    .closebtn{margin-left:15px;color:inherit;font-weight:bold;float:right;font-size:22px;line-height:20px;cursor:pointer;transition:.3s}
    .closebtn:hover{opacity:.7}

    /* Accordion */
    #sessionPromptHistoryContainer,#searchResultsContainer{margin-top:30px;border:1px solid #dee2e6;border-radius:8px;overflow:hidden;padding:1px}
    .accordion-item{border-bottom:1px solid #e0e0e0}
    .accordion-item:last-child{border-bottom:none}
    .accordion-button{background:#f8f9fa;color:#495057;cursor:pointer;padding:15px 20px;width:100%;text-align:left;border:none;outline:none;transition:background .3s;font-size:1.1em;font-weight:bold;display:flex;justify-content:space-between;align-items:center;margin-top:0}
    .accordion-button:hover{background:#e2e6ea}
    .accordion-button.active{background:#e9ecef;color:#0056b3}
    .accordion-button:after{content:'\02795';font-size:.8em;color:#777;margin-left:5px;transition:transform .3s}
    .accordion-button.active:after{content:'\2796'}
    .accordion-panel{padding:0 20px;background:#fff;max-height:0;overflow:hidden;transition:max-height .3s ease-out,padding .3s ease-out;box-sizing:border-box;padding-bottom:0}
    .accordion-panel.active{padding-top:15px;padding-bottom:15px}
    .accordion-panel pre{background:#e9ecef;padding:15px;border-radius:4px;white-space:pre-wrap;word-wrap:break-word;font-family:monospace;font-size:.9em;margin:0;line-height:1.4em}
    .button-group{text-align:right;margin-top:15px}
    .button-group button{padding:8px 15px;font-size:14px;margin-left:10px;border-radius:4px;border:none;cursor:pointer}
    .copy-button{background:#28a745!important;color:#fff!important}
    .copy-button:hover{background:#218838!important}
    .load-button{background:#17a2b8!important}
    .load-button:hover{background:#138496!important}
    .delete-button{background:#dc3545!important}
    .delete-button:hover{background:#c82333!important}
    .no-prompts-message{text-align:center;color:#6c757d;padding:20px}

    /* Search controls */
    .search-controls{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:20px;align-items:flex-end}
    .search-controls>div{flex:1 0 150px;margin-bottom:0}
    .pagination-controls{text-align:center;margin-top:20px}
    .pagination-controls button{padding:8px 15px;margin:0 5px;background:#6c757d;color:#fff;border:none;border-radius:4px;cursor:pointer}
    .pagination-controls button:disabled{background:#e9ecef;color:#6c757d;cursor:not-allowed}
    .pagination-controls span{font-weight:bold;margin:0 10px}

    /* Tooltips */
    .tooltip{position:relative;display:inline-block;cursor:help;color:#007bff;font-weight:normal;margin-left:5px}
    .tooltip .tooltiptext{visibility:hidden;width:400px;max-height:250px;overflow-y:auto;background:#333;color:#fff;text-align:left;border-radius:6px;padding:10px;position:absolute;z-index:100;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .3s;font-size:.85em;line-height:1.4em}
    .tooltip:hover .tooltiptext{visibility:visible;opacity:1}
    .tooltip i.tooltip-icon{font-size:22px;color:#007bff;margin-left:6px;cursor:pointer;transition:color .2s}
    .tooltip i.tooltip-icon:hover{color:#0056b3}

    /* Chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:-10px 0 12px 0}
    .chip{background:#eef5ff;color:#0056b3;border:1px solid #cfe2ff;padding:6px 10px;border-radius:16px;font-size:.85em;cursor:pointer}
    .chip:hover{background:#e2ecff}

    /* Layout with side panel */
    .flex-wrap{display:grid;grid-template-columns:1fr 320px;gap:18px}
    @media (max-width:1024px){.flex-wrap{grid-template-columns:1fr}}

    /* Side panel */
    .side-panel{position:sticky;top:12px;align-self:start;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:14px}
    .side-panel h3{margin:6px 0 10px 0;font-size:1.05rem;color:#333}
    .side-panel .meter{font-size:.9em;color:#555;margin:4px 0 8px 0}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:12px;font-weight:600;
      font-size:.75rem;line-height:1;border:1px solid transparent
    }
    .badge--idle   { background:#e2e8f0; color:#0f172a; border-color:#cbd5e1 } /* slate on gray */
    .badge--typing { background:#fff7ed; color:#7c2d12; border-color:#fed7aa } /* amber */
    .badge--saved  { background:#dcfce7; color:#14532d; border-color:#bbf7d0 } /* green */
    .badge--error  { background:#fee2e2; color:#7f1d1d; border-color:#fecaca } /* red */
    .badge--clear  { background:#f1f5f9; color:#0f172a; border-color:#e2e8f0 } /* neutral */

    /* Preview */
    .preview{white-space:pre-wrap;border:1px solid #e5e7eb;border-radius:8px;padding:12px;background:#f9fafb;font-family:system-ui,sans-serif;font-size:.92em}
    .preview-toolbar{display:flex;gap:8px;margin:8px 0 10px}
    .btn-sm{padding:6px 10px;font-size:.85em;border-radius:6px;background:#6c757d;color:#fff;border:none}
    .btn-sm:hover{background:#5a636a}
    .btn-outline{background:#fff;color:#333;border:1px solid #d1d5db}
    .btn-outline:hover{background:#f3f4f6}

    /* Inline controls */
    .inline-controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 16px}
    .inline-controls select,.inline-controls input[type="text"]{margin:0;height:36px}
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <div class="modal fade" id="wizardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content" style="border-radius:12px;">
        <div class="modal-header">
          <h5 class="modal-title" id="wizardModalTitle">Wizard</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="wizardForm">
          <div class="modal-body" id="wizardModalBody">
            <!-- dynamic -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Insert</button>
          </div>
        </form>
      </div>
    </div>
  </div>  

  <div class="container">
    <div id="alert-banner" class="alert" style="display:none;">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
      <span id="alert-message"></span>
    </div>

    <h1>Gen AI Prompt Constructor</h1>

    <label for="methodSelector">Select Prompt Method:</label>
    <select id="methodSelector">
      <option value="tcrei">TCREI Method (Text Generation)</option>
      <option value="design">DESIGN Method (Image Generation)</option>
       <option value="agent">Agent Mode (Research & Implement)</option>
    </select>

    <hr>

    <!-- Controls row: presets, mode, variables -->
    <div class="inline-controls">
      <label style="font-weight:600;">Template:</label>
      <select id="templatePreset">
        <option value="">— Loading templates… —</option>
      </select>
      <label style="font-weight:600;">Audience:</label>
      <input type="text" id="varAudience" placeholder="e.g., non-technical SMB owners" oninput="renderPreview()">
      <label style="font-weight:600;">Tone:</label>
      <input type="text" id="varTone" placeholder="e.g., friendly, professional" oninput="renderPreview()">
      <label style="font-weight:600;">Length:</label>
      <input type="text" id="varLength" placeholder="e.g., ~800 words" oninput="renderPreview()">
    </div>

    <div class="flex-wrap">
      <div>
        <!-- TCREI -->
        <div id="tcreiMethod" class="method-section active">
          <h2>TCREI Method (Text Generation)</h2>
          <p>Using Google's TCREI Method:</p>
          <ul>
            <li><strong>T</strong>houghtfully: Describe your <strong>task</strong>, specifying a persona and format preference.</li>
            <li><strong>C</strong>reate: Include any <strong>context</strong> the gen AI tool might need.</li>
            <li><strong>R</strong>eally: Add <strong>references</strong> the gen AI tool can use to inform its output.</li>
            <li><strong>E</strong>xcellent: Evaluate the output and spot improvements (after generation).</li>
            <li><strong>I</strong>nputs: Iterate on your prompt to attain those improvements (after generation).</li>
          </ul>

          <!-- Thoughtfully (Task) -->
          <div class="section-title">Thoughtfully (Task)</div>
          <label for="tcrei_task">
            Describe your task:
            <span class="tooltip">
              <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
              <span class="tooltiptext">
                • Write a blog post explaining {{topic}} to {{audience}}<br>
                • Summarise a research paper into a 1-page brief<br>
                • Translate a product description to Spanish (friendly tone)<br>
                • Script a 2-minute explainer on renewable energy<br>
                • Generate 15 quiz questions (with answers)<br>
              </span>
            </span>
          </label>
          <textarea id="tcrei_task" placeholder="e.g., 'Write a compelling blog post…'"></textarea>
          <div class="chips">
            <span class="chip" onclick="insertChip('tcrei_task','Write a blog post explaining {{topic}} to {{audience}}.')">Task: blog post</span>
            <span class="chip" onclick="insertChip('tcrei_task','Summarise the following into key bullet points for {{audience}}.')">Task: summary</span>
            <span class="chip" onclick="insertChip('tcrei_task','Translate this into Spanish, preserve line breaks, friendly tone.')">Task: translate</span>
            <span class="chip" onclick="randomiseField('tcrei_task','task')">Randomise</span>
          </div>

          <!-- Specify Format or Persona -->
          <div class="section-title">Specify Format or Persona</div>
          <label for="tcrei_format">
            Format / persona:
            <span class="tooltip">
              <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
              <span class="tooltiptext">
                • Formatted in Markdown<br>
                • As a bulleted list<br>
                • Persona: senior cybersecurity consultant<br>
                • Written in a humorous, sarcastic tone<br>
              </span>
            </span>
          </label>
          <textarea id="tcrei_format" placeholder="e.g., 'Formatted in Markdown' or 'Persona: …'"></textarea>
          <div class="chips">
            <span class="chip" onclick="insertChip('tcrei_format','Formatted in Markdown')">Markdown</span>
            <span class="chip" onclick="insertChip('tcrei_format','As bullet points with sub-bullets')">Bulleted</span>
            <span class="chip" onclick="insertChip('tcrei_format','Persona: Act as a senior cybersecurity consultant')">Persona</span>
            <span class="chip" onclick="insertChip('tcrei_format','Tone: {{tone}}')">Tone</span>
          </div>

          <!-- Create (Context) -->
          <div class="section-title">Create (Context)</div>
          <label for="tcrei_context">
            Context:
            <span class="tooltip">
              <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
              <span class="tooltiptext">
                • Audience: {{audience}}<br>
                • Length: {{length}}<br>
                • Include 3 real-world examples<br>
                • Use UK English spelling<br>
              </span>
            </span>
          </label>
          <textarea id="tcrei_context" placeholder="e.g., 'Audience: non-technical SMB owners; Length: ~800 words…'"></textarea>
          <div class="chips">
            <span class="chip" onclick="insertChip('tcrei_context','Audience: {{audience}}')">Audience</span>
            <span class="chip" onclick="insertChip('tcrei_context','Length: {{length}}')">Length</span>
            <span class="chip" onclick="insertChip('tcrei_context','Constraints: avoid jargon; include 3 examples')">Constraints</span>
          </div>

          <!-- Really (References) -->
          <div class="section-title">Really (References)</div>
          <label for="tcrei_references">References or examples:</label>
          <textarea id="tcrei_references" placeholder="e.g., 'Use these URLs… or paste exemplar text'"></textarea>

          <!-- Inputs (Iterate) -->
          <div class="section-title">Inputs (Iterate)</div>
          <label for="tcrei_iterate">
            How should it improve/iterate?
            <span class="tooltip">
              <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
              <span class="tooltiptext">
                • Expand intro with story<br>
                • Make summary snappier<br>
                • Provide pros/cons then a recommendation<br>
              </span>
            </span>
          </label>
          <textarea id="tcrei_iterate" placeholder="e.g., 'Shorten by half; add CTA; remove redundancy'"></textarea>
          <div class="chips">
            <span class="chip" onclick="insertChip('tcrei_iterate','Critique for clarity and remove redundancy')">Critique clarity</span>
            <span class="chip" onclick="insertChip('tcrei_iterate','Add a clear call to action at the end')">Add CTA</span>
            <span class="chip" onclick="insertChip('tcrei_iterate','Provide both pros and cons, then conclude with a recommendation')">Pros/Cons + Rec</span>
          </div>

          <div class="checkbox-container">
            <input type="checkbox" id="tcrei_add_tags">
            <label for="tcrei_add_tags">Add XML-like tags to output (e.g., &lt;task&gt;)</label>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" onclick="generatePromptAndSave('tcrei')">Generate TCREI Prompt & Save</button>
            <button type="button" class="btn-outline btn-sm" onclick="makeABVariants()">A/B Variants</button>
            <button type="button" class="btn-outline btn-sm" onclick="randomiseField('tcrei_task','task')">Randomise Task</button>
          </div>
        </div>

        <!-- DESIGN (your existing fields stay; you can mirror preview later if you want) -->
        <div id="designMethod" class="method-section">
          <h2>DESIGN Method (Image Generation)</h2>
          <p>Using the DESIGN Method:</p>
          <ul>
            <li><strong>D</strong>escription</li><li><strong>E</strong>nvironment</li><li><strong>S</strong>tyle</li><li><strong>I</strong>llumination</li><li><strong>G</strong>radation</li><li><strong>N</strong>uances</li>
          </ul>
        <div class="section-title">Description (Subject & Action)</div>
        <label for="design_description">
          Core subject or action
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Subjects</strong><br>
              • Animal: cat, dog, owl, horse<br>
              • Person: child, traveller, knight, astronaut<br>
              • Object: vintage camera, broken clock, crystal goblet<br>
              • Creature: dragon, phoenix, alien<br>
              • Abstract: swirling energy, fractal geometry<br>
              <br>
              <strong>Actions</strong><br>
              • Running, leaping, floating, gazing<br>
              • Reading, painting, cooking, inventing<br>
              • Battling, defending, embracing, dancing<br>
              • Exploring, discovering, meditating<br>
              <br>
              <strong>Tips</strong><br>
              Combine subject + action for clarity:<br>
              – “A curious cat batting at a butterfly”<br>
              – “An astronaut planting a flag on Mars”<br>
              – “A knight kneeling before a stained-glass window”<br>
            </span>
          </span>
        </label>
        <textarea id="design_description" placeholder="e.g., 'A curious cat batting at a butterfly.'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_description','A curious cat batting at a butterfly')">Cat + butterfly</span>
          <span class="chip" onclick="insertChip('design_description','An astronaut planting a flag on Mars')">Astronaut + flag</span>
          <span class="chip" onclick="insertChip('design_description','A knight kneeling before a stained-glass window')">Knight + prayer</span>
          <span class="chip" onclick="insertChip('design_description','A phoenix bursting into flames mid-flight')">Phoenix</span>
          <span class="chip" onclick="insertChip('design_description','A child discovering a glowing crystal in a cave')">Crystal cave</span>
        </div>

        <div class="section-title">Environment (Setting & Background)</div>
        <label for="design_environment">
          Setting
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Natural settings</strong><br>
              • In an old, sun-dappled forest<br>
              • On a windswept desert dune<br>
              • Atop a snowy mountain peak<br>
              • Under the ocean, coral reef teeming with life<br>
              • In a misty swamp with glowing fungi<br>
              <br>
              <strong>Human-made settings</strong><br>
              • In an ancient library with towering shelves<br>
              • In a futuristic neon cityscape<br>
              • Inside a rustic cabin with fireplace<br>
              • On a bustling medieval marketplace<br>
              • In a ruined temple overgrown with vines<br>
              <br>
              <strong>Atmospheres</strong><br>
              • Dreamlike haze • Post-apocalyptic wasteland • Cozy interior • Majestic and grand • Minimalist blank space<br>
              <br>
              <strong>Tips</strong><br>
              Anchor the subject in space/time:<br>
              – “In an old, sun-dappled library”<br>
              – “On a spaceship drifting through Saturn’s rings”<br>
              – “At a neon-lit ramen stall in a rainy alley”<br>
            </span>
          </span>
        </label>
        <textarea id="design_environment" placeholder="e.g., 'In an old, sun-dappled library.'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_environment','In an old, sun-dappled library with towering bookshelves')">Library</span>
          <span class="chip" onclick="insertChip('design_environment','In a futuristic neon cityscape, rain-slick streets')">Cyberpunk city</span>
          <span class="chip" onclick="insertChip('design_environment','On a snowy mountain peak above the clouds')">Snowy peak</span>
          <span class="chip" onclick="insertChip('design_environment','Inside a rustic cabin with a glowing fireplace')">Rustic cabin</span>
          <span class="chip" onclick="insertChip('design_environment','At a neon-lit ramen stall in a rainy alley')">Ramen stall</span>
          <span class="chip" onclick="insertChip('design_environment','On a spaceship drifting through Saturn’s rings')">Spaceship</span>
        </div>


        <div class="section-title">Style (Artistic & Visual Aesthetic)</div>
        <label for="design_style">
          Style
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Common styles</strong><br>
              • Photorealistic, cinematic still<br>
              • Fine art oil painting (impasto)<br>
              • Watercolor illustration, loose washes<br>
              • Charcoal sketch, cross-hatching<br>
              • Line art, minimal ink<br>
              • Matte painting, concept art<br>
              • Anime keyframe, clean linework<br>
              • Ghibli-inspired soft fantasy<br>
              • Pixar-like 3D render<br>
              • Isometric, low-poly<br>
              • Pixel art, 16-bit<br>
              • Noir, high-contrast B/W<br>
              • Vaporwave, synthwave<br>
              • Cyberpunk neon<br>
              • Art Deco / Bauhaus<br>
              • Ukiyo-e woodblock print<br>
              • Surrealist (Magritte/Dalí)<br>
              • Impressionist (Monet/Vang Gogh vibe)<br>
              • Pop art, halftone dots<br>
              <br>
              <strong>Medium / surface</strong><br>
              • Oil on canvas • Gouache on textured paper • Ink on rice paper • Chalk on blackboard • Spray paint on concrete<br>
              <br>
              <strong>Reference artists (optional)</strong><br>
              • “in the style of …” *only if allowed by your tool* (otherwise say “inspired by ...”)<br>
            </span>
          </span>
        </label>
        <textarea id="design_style" placeholder="e.g., 'Photorealistic, cinematic still.' or 'Oil painting'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_style','Photorealistic, cinematic still')">Photorealistic</span>
          <span class="chip" onclick="insertChip('design_style','Fine art oil painting, impasto brushwork')">Oil painting</span>
          <span class="chip" onclick="insertChip('design_style','Watercolor illustration, loose washes')">Watercolor</span>
          <span class="chip" onclick="insertChip('design_style','Anime keyframe, clean linework')">Anime</span>
          <span class="chip" onclick="insertChip('design_style','Ukiyo-e woodblock print aesthetic')">Ukiyo-e</span>
          <span class="chip" onclick="insertChip('design_style','Isometric, low-poly render')">Isometric</span>
          <span class="chip" onclick="insertChip('design_style','Noir, high-contrast black & white')">Noir</span>
        </div>

        <div class="section-title">Illumination (Lighting & Time)</div>
        <label for="design_illumination">
          Lighting
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Natural light</strong><br>
              • Golden hour backlight, long soft shadows<br>
              • Blue hour ambient with city glow<br>
              • Overcast diffuse softbox light<br>
              • Harsh noon sun, high contrast<br>
              • Moonlit night, cool tones<br>
              • Volumetric god rays through fog<br>
              <br>
              <strong>Artificial light</strong><br>
              • Studio three-point lighting (key/fill/rim)<br>
              • Rembrandt lighting (triangle cheek highlight)<br>
              • Split lighting (dramatic halves)<br>
              • Neon signage spill, rim highlights<br>
              • Candlelit interior, warm pockets of light<br>
              • Firelight flicker, warm orange<br>
              <br>
              <strong>Time & atmosphere</strong><br>
              • Dawn pastel sky • Sunset pink/amber bounce • Stormy clouds with shafts of light • Hazy dust motes<br>
            </span>
          </span>
        </label>
        <textarea id="design_illumination" placeholder="e.g., 'Golden hour backlight'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_illumination','Golden hour backlight, long soft shadows')">Golden hour</span>
          <span class="chip" onclick="insertChip('design_illumination','Blue hour city glow, neon highlights')">Blue hour</span>
          <span class="chip" onclick="insertChip('design_illumination','Overcast diffuse softbox lighting')">Overcast soft</span>
          <span class="chip" onclick="insertChip('design_illumination','Studio three-point lighting (key, fill, rim)')">Studio 3-point</span>
          <span class="chip" onclick="insertChip('design_illumination','Candlelit interior, warm pools of light')">Candlelit</span>
          <span class="chip" onclick="insertChip('design_illumination','Volumetric god rays through dusty windows')">God rays</span>
        </div>
        <div class="section-title">Gradation (Quality & Detail)</div>
        <label for="design_gradation">
          Quality
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Resolution / fidelity</strong><br>
              • 8K, masterpiece, sharp focus • Ultra-real textures, micro-detail • HDR wide dynamic range<br>
              • Print-ready (≈300 DPI) • Film grain subtle<br>
              <br>
              <strong>Rendering hints</strong><br>
              • PBR materials, physically based rendering<br>
              • Global illumination, ray-traced reflections<br>
              • Subsurface scattering (skin) • Ambient occlusion<br>
              • Depth of field with creamy bokeh<br>
              <br>
              <strong>Lens & camera (optional)</strong><br>
              • 24mm wide • 50mm standard • 85mm portrait • Macro 1:1<br>
            </span>
          </span>
        </label>
        <textarea id="design_gradation" placeholder="e.g., '8K, masterpiece, sharp focus.'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_gradation','8K, masterpiece, sharp focus')">8K masterpiece</span>
          <span class="chip" onclick="insertChip('design_gradation','Ultra-real textures, micro-detail, HDR')">Ultra-real HDR</span>
          <span class="chip" onclick="insertChip('design_gradation','PBR materials, global illumination, ray-traced reflections')">PBR + GI + RT</span>
          <span class="chip" onclick="insertChip('design_gradation','Subsurface skin scattering, ambient occlusion')">SSS + AO</span>
          <span class="chip" onclick="insertChip('design_gradation','Shallow depth of field, creamy bokeh')">DOF + bokeh</span>
        </div>

        <div class="section-title">Nuances (Modifiers & Negative Prompts)</div>
        <label for="design_nuances">
          Nuances
          <span class="tooltip">
            <i class="fa-solid fa-circle-info fa-spin tooltip-icon"></i>
            <span class="tooltiptext">
              <strong>Camera & composition</strong><br>
              • Low angle hero shot (24mm) • High angle bird’s-eye • Over-the-shoulder framing<br>
              • Rule of thirds, subject off-center • Leading lines • Foreground framing (leaves/arches)<br>
              • Motion blur background, subject sharp • Dutch tilt for tension<br>
              <br>
              <strong>Stylistic modifiers</strong><br>
              • Weathered, patina • Bioluminescent accents • Misty, ethereal<br>
              • Minimalist • Maximalist • Symmetry / asymmetry<br>
              <br>
              <strong>Negative prompts (avoid)</strong><br>
              • Negative: blurry, out of focus, noise, watermark, text artifacts<br>
              • Negative: deformed anatomy, extra fingers, distorted faces<br>
              • Negative: over-saturated colors, banding, JPEG artifacts<br>
            </span>
          </span>
        </label>
        <textarea id="design_nuances" placeholder="e.g., 'Low angle hero shot; Negative: blurry, watermark'"></textarea>
        <div class="chips">
          <span class="chip" onclick="insertChip('design_nuances','Low angle hero shot, 24mm lens')">Low-angle 24mm</span>
          <span class="chip" onclick="insertChip('design_nuances','Over-the-shoulder framing, shallow DOF')">OTS + DOF</span>
          <span class="chip" onclick="insertChip('design_nuances','Rule of thirds, subject off-center')">Rule of thirds</span>
          <span class="chip" onclick="insertChip('design_nuances','Motion blur background, subject sharp')">Motion blur</span>
          <span class="chip" onclick="insertChip('design_nuances','Negative: blurry, noise, watermark, text artifacts')">Neg: blur/noise/text</span>
          <span class="chip" onclick="insertChip('design_nuances','Negative: deformed anatomy, extra fingers, distorted faces')">Neg: anatomy</span>
        </div>

          <div class="section-title">Visual References / Examples</div>
          <label for="design_references">References / URLs</label>
          <textarea id="design_references" placeholder="e.g., 'Inspired by…; ref: https://…'"></textarea>

          <button type="button" onclick="generatePromptAndSave('design')">Generate DESIGN Prompt & Save</button>
        </div>
        <!-- AGENT (Research & Implement) -->
        <div id="agentMethod" class="method-section">
          <h2>Agent Mode (Research & Implement)</h2>
          <div class="section-title">Agent Template</div>
          <label for="agentTemplate">Choose a template</label>
          <select id="agentTemplate"></select>
          <small id="agentTemplateDesc" style="display:block;color:#666;margin-top:6px;"></small>
          <p>Build a browsable, source-cited, implementation-oriented prompt for an autonomous agent.</p>

          <div class="section-title">Objective</div>
          <label for="agent_objective">What do you want achieved?</label>
          <textarea id="agent_objective" placeholder="e.g., Implement membership renewal resend link in Woo admin..."></textarea>
<div class="chips">
  <span class="chip" onclick="insertChip('agent_objective','Implement admin action: resend membership renewal email for a user')">Implement action</span>
  <span class="chip" onclick="insertChip('agent_objective','Fix bug: double-charging on renewal when status is pending-cancel')">Fix bug</span>
  <span class="chip" onclick="insertChip('agent_objective','Research and propose approach for multi-step form with validation + autosave')">Research & propose</span>
  <span class="chip" onclick="insertChip('agent_objective','Create migration plan to rotate Stripe API keys across environments')">Migration plan</span>
  <span class="chip" onclick="objectiveWizard()">Guide me…</span>
</div>

          <div class="section-title">Success Criteria</div>
          <label for="agent_success">How will we measure success?</label>
          <textarea id="agent_success" placeholder="e.g., Link appears under 'Next Bill On', sends correct email template, logs action..."></textarea>
<div class="chips">
  <span class="chip" onclick="insertChip('agent_success','- Admin UI shows a “Resend Renewal” link under Next Bill On\n- Correct email template is sent and logged\n- Action is nonce-protected and capability-checked\n- Unit test covers happy-path + invalid nonce')">Typical AC</span>
  <span class="chip" onclick="insertChip('agent_success','- Page load impact < 50ms\n- No new PHP warnings/notices\n- Rollback plan documented in PR')">Perf/quality</span>
  <span class="chip" onclick="successWizard()">Guide me…</span>
</div>

          <div class="section-title">Scope / Out of Scope</div>
          <label for="agent_scope">In scope (bullet list)</label>
          <textarea id="agent_scope" placeholder="- Add admin link\n- Trigger existing email template\n- Include nonce + capability checks"></textarea>
<div class="chips">
  <span class="chip" onclick="insertChip('agent_scope','- Add admin link under Next Bill On\n- Trigger existing renewal email template\n- Log action with user/timezone (AEST)\n- Unit/integration tests where practical')">Core scope</span>
  <span class="chip" onclick="insertChip('agent_scope','- Use WP nonces + capability checks\n- No raw SQL unless $wpdb->prepare\n- Escaping/sanitization on all inputs/outputs')">Security scope</span>
  <span class="chip" onclick="scopeWizard()">Guide me…</span>
</div>

          <label for="agent_outofscope">Out of scope (bullet list)</label>
          <textarea id="agent_outofscope" placeholder="- New email templates\n- DB schema changes"></textarea>
<div class="chips">
  <span class="chip" onclick="insertChip('agent_outofscope','- Creating new email templates\n- DB schema changes\n- Subscription proration logic\n- Payment provider switching')">Common OOS</span>
  <span class="chip" onclick="outOfScopeWizard()">Guide me…</span>
</div>

          <div class="section-title">Constraints</div>
          <label for="agent_constraints">Perf, security, compliance, time/budget</label>
          <textarea id="agent_constraints" placeholder="- Follow WP nonces/escapes\n- No raw SQL without $wpdb->prepare\n- AEST logs only"></textarea>
          <div class="chips">
            <span class="chip" onclick="insertChip('agent_constraints','- Performance: TTFB < 200ms; DB queries < 100ms; cache reads; paginate long lists')">Perf budget</span>
            <span class="chip" onclick="insertChip('agent_constraints','- Security: Nonce + capability checks; sanitize/escape; use $wpdb->prepare for SQL')">Security basics</span>
            <span class="chip" onclick="insertChip('agent_constraints','- Compliance: No PII in logs; respect consent; redact user data in errors')">Compliance</span>
            <span class="chip" onclick="insertChip('agent_constraints','- Time/Budget: MVP in 6 hours; no paid APIs; prioritize low-risk changes')">Time/Budget</span>
            <span class="chip" onclick="insertChip('agent_constraints','- Reliability/Observability: Log in AEST; handle errors; backoff retries for remote calls')">Reliability</span>
            <span class="chip" onclick="constraintsWizard()">Guide me…</span>
          </div>

          <div class="section-title">Environment Details</div>
          <label for="agent_env">Versions, plugin names, paths</label>
          <textarea id="agent_env" placeholder="PHP 8+, WP + Woo, Local by Flywheel (Win11), prod on Flywheel (NGINX). Plugin: /wp-content/plugins/oi-mods/ (single repo). TZ: Australia/Brisbane (AEST; no DST)."></textarea>
<div class="chips">
  <span class="chip" onclick="insertChip('agent_env','PHP 8.2; WordPress 6.5+; WooCommerce 8.x\nLocal: Win11 (Local by Flywheel)\nProd: Flywheel (NGINX)\nPlugin: /wp-content/plugins/oi-mods/\nTZ: Australia/Brisbane (AEST; no DST)')">WP/Woo baseline</span>
  <span class="chip" onclick="insertChip('agent_env','Node 20.x for tooling; Composer 2.x; MySQL 8.x\nError logging: AEST; redact PII\nFeature flags via env var')">Tooling baseline</span>
  <span class="chip" onclick="envWizard()">Guide me…</span>
</div>

          <div class="section-title">Extra Vendor Docs (optional)</div>
          <label for="agent_extra_sources">Add domain-specific docs to prioritize</label>
          <textarea id="agent_extra_sources" placeholder="- Formidable Forms developer docs\n- Woo Memberships docs"></textarea>
<div class="chips">
  <span class="chip" onclick="insertChip('agent_extra_sources','- WordPress Developer Docs\n- WooCommerce Memberships Docs\n- Formidable Forms Developer Docs')">WP stack</span>
  <span class="chip" onclick="insertChip('agent_extra_sources','- Stripe API Docs (Billing/Invoices)\n- Flywheel Platform Docs\n- PHP-FIG PSR-12 (coding style)')">Infra/payment</span>
  <span class="chip" onclick="vendorWizard()">Guide me…</span>
</div>

          <button type="button" onclick="generatePromptAndSave('agent')">Generate Agent Prompt & Save</button>
        </div>

      </div>

      <!-- Side panel -->
      <aside class="side-panel">
        <h3>Final Prompt Preview</h3>
        <div class="preview-toolbar">
          <button class="btn-sm" onclick="copyPreview()">Copy (with tags)</button>
          <button class="btn-sm btn-outline" onclick="copyPreview(true)">Copy clean</button>
          <button class="btn-sm btn-outline" onclick="exportPrompt()">Export JSON</button>
          <label class="btn-sm btn-outline" style="cursor:pointer;">
            Import JSON <input type="file" id="importFile" accept="application/json" style="display:none" onchange="importPrompt(event)">
          </label>
        </div>
        <div id="livePreview" class="preview">Start typing to see a live preview…</div>

        <h3 style="margin-top:16px;">Quality Checks</h3>
        <div id="linter" class="meter"></div>

        <h3>Length & Tokens</h3>
        <div id="lengthInfo" class="meter"></div>

        <div style="margin-top:12px;">
          <span class="badge" id="autosaveStatus">Autosave: idle</span>
          <button class="btn-sm btn-outline" onclick="restoreDraft()">Restore draft</button>
          <button class="btn-sm btn-outline" onclick="clearDraft()">Clear draft</button>
        </div>
      </aside>
    </div>

    <hr>

    <h2>Current Session Prompts</h2>
    <div id="sessionPromptHistoryContainer">
      <p class="no-prompts-message">Prompts generated in this session will appear here. They’re saved to the database but will clear here on refresh.</p>
    </div>

    <hr>

    <h2>Search & Manage Saved Prompts</h2>
    <div class="search-controls">
      <div>
        <label for="searchPromptType">Filter by Type:</label>
        <select id="searchPromptType">
          <option value="All">All Types</option>
          <option value="tcrei">TCREI</option>
          <option value="design">DESIGN</option>
           <option value="agent">AGENT</option>
        </select>
      </div>

      <div>
        <label for="searchKeyword">Search Keyword:</label>
        <input type="text" id="searchKeyword" placeholder="Search by title or content...">
      </div>

      <div>
        <label for="searchSortBy">Sort By:</label>
        <select id="searchSortBy">
          <option value="created_at" selected>Created</option>
          <option value="title">Title</option>
          <option value="type">Type</option>
        </select>
      </div>

      <div>
        <label for="searchSortDir">Direction:</label>
        <select id="searchSortDir">
          <option value="desc" selected>Desc</option>
          <option value="asc">Asc</option>
        </select>
      </div>

      <div>
        <label for="searchMode">Search Mode:</label>
        <select id="searchMode" title="auto uses FULLTEXT if available, else LIKE">
          <option value="auto" selected>Smart (auto)</option>
          <option value="like">LIKE</option>
          <option value="fulltext">FULLTEXT</option>
        </select>
      </div>

      <div style="min-width: 160px;">
        <label for="includeDeleted">Include deleted</label>
        <input type="checkbox" id="includeDeleted" />
      </div>

      <button type="button" onclick="searchPrompts(1, true)">Search Prompts</button>
      <button type="button" onclick="listAllPrompts()">List All Prompts</button>
    </div>
    <div id="searchResultsContainer">
      <p class="no-prompts-message">Search results will appear here. Use "List All Prompts" to see all saved entries.</p>
    </div>

    <div class="pagination-controls">
      <button id="prevPageBtn" onclick="changePage(-1)" disabled>Previous</button>
      <span id="currentPageSpan">Page 1 of 1</span>
      <button id="nextPageBtn" onclick="changePage(1)" disabled>Next</button>
    </div>

    <button id="clearAllDbPrompts" class="clear-all-db-prompts" type="button" style="display:none;">Clear ALL Saved Prompts (from Database)</button>
  </div>

  <!-- Core logic (enhancements + your existing functions) -->
  <script>
    // Null-safe DOM helpers
    const $ = (id) => document.getElementById(id);
    const val = (id) => ($(`${id}`)?.value ?? '');
    const checked = (id) => !!$(`${id}`)?.checked;

    let sessionPromptCounter=0,lastRestoredPromptData=null,currentSearchPage=1,totalPages=1;
    const promptsPerPage=10;
    let DB_AGENT_TEMPLATES = {}; 
    let DB_TCREI_TEMPLATES = {};
    let DB_DESIGN_TEMPLATES = {};

    async function fetchTemplates(category) {
      const res = await fetch(`php/templates_list.php?category=${encodeURIComponent(category)}&include_payload=1`);
      if (!res.ok) throw new Error(`Failed to load ${category} templates`);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || `Bad ${category} list`);
      const map = {};
      for (const t of data.templates) {
        try {
          if (t.payload && typeof t.payload === 'string') t.payload = JSON.parse(t.payload);
        } catch (e) {
          console.warn('Bad payload JSON for template', t.key, e);
          t.payload = {};
        }
        map[t.key] = t;
      }
      return map;
    }
    // Hoisted/TDZ-safe autosave timer
    var autosaveTimer = null;

    function setAutosaveStatus(state, text){
      const b = document.getElementById('autosaveStatus');
      if (!b) return;
      b.className = 'badge badge--' + state;
      b.textContent = text;
    }

    function scheduleAutosave(){
      setAutosaveStatus('typing','Autosave: typing…');
      try { clearTimeout(autosaveTimer); } catch(_) {}
      autosaveTimer = setTimeout(saveDraft, 600);
    }

    // Mini local fallback presets (only used if DB returns nothing or errors)
    const TCREI_FALLBACK_PRESETS = {
      blog:{label:'Blog Post',payload:{
        task:"Write a blog post explaining {{topic}} to {{audience}}.",
        format:"Formatted in Markdown. Use headings, short paragraphs, and bullet lists where helpful.",
        context:"Tone: {{tone}}. Length: {{length}}. Include 3 real-world examples and a brief conclusion.",
        references:"",
        iterate:"Critique for clarity, remove redundancy, add a concise summary at the end."
      }},
      product:{label:'Product Description',payload:{
        task:"Create a compelling product description for {{topic}}.",
        format:"Markdown with intro, bullet features, and benefits section.",
        context:"Audience: {{audience}}. Tone: {{tone}}. Length: {{length}}.",
        references:"Use brand style guide where applicable.",
        iterate:"Tighten copy; emphasise benefits; add a persuasive CTA."
      }},
      email:{label:'Email Campaign',payload:{
        task:"Write an email campaign introducing {{topic}} to {{audience}}.",
        format:"Subject + preview + body (short paragraphs + bullets).",
        context:"Tone: {{tone}}. Keep it concise. One strong CTA.",
        references:"",
        iterate:"A/B test two subject lines and two CTAs."
      }},
      bug:{label:'Bug Report',payload:{
        task:"Draft a clear bug report.",
        format:"Sections: Summary, Steps, Expected, Actual, Environment, Screenshots.",
        context:"Audience: engineering. Be precise; avoid ambiguity.",
        references:"",
        iterate:"Ensure steps are minimal yet reproducible."
      }}};
      const AGENT_FALLBACK_TEMPLATES = {
        wordpress_programmer: {
          label: 'WordPress Programmer',
          description: 'Research + implement in WP/Woo contexts',
          payload: {
            defaults: {
              env: 'PHP 8.2; WordPress 6.5+; WooCommerce 8.x\nLocal: Win11 (Local by Flywheel)\nProd: Flywheel (NGINX)\nPlugin: /wp-content/plugins/oi-mods/\nTZ: Australia/Brisbane (AEST; no DST)',
              scope: '- Add admin link\n- Reuse existing templates\n- Nonce + capability checks\n- Logging (actor/user/time, AEST)\n- Unit/integration tests',
              outofscope: '- New email templates\n- DB schema changes\n- Payment provider switching',
              constraints: '- Performance: TTFB < 200ms; DB < 100ms\n- Security: sanitize/escape; $wpdb->prepare\n- Compliance: no PII in logs\n- Time/Budget: MVP today'
            }
          }
        },
        research_general: {
          label: 'Researcher (General)',
          description: 'Source-cited research + summary',
          payload: {
            defaults: {
              env: '',
              scope: '- Triage sources\n- Summarise with quotes\n- Provide links + inline citations',
              outofscope: '- Long code implementations\n- Non-public/unverifiable claims',
              constraints: '- Cite every non-obvious claim\n- Prefer primary/vendor docs\n- Timebox: 2 hours'
            }
          }
        }
      };

    function applyTcreiTemplate(key){
      if (!key) return;

      // Prefer DB payload
      const row = DB_TCREI_TEMPLATES?.[key];
      if (row?.payload) {
        applyTcreiTemplateFromPayload(row.payload);
        return;
      }

      // Local fallback
      const fb = TCREI_FALLBACK_PRESETS?.[key];
      if (fb?.payload) {
        applyTcreiTemplateFromPayload(fb.payload);
        return;
      }

      console.warn('TCREI template not found for key:', key);
    }
    /**
    * Apply a TCREI template row from DB into the five TCREI fields.
    * Falls back to legacy PRESETS if the key isn’t in DB.
    */
    function applyTcreiTemplate(key) {
      if (!key) return;

      const row = DB_TCREI_TEMPLATES[key];
      if (!row || !row.payload) {
        // Fallback to legacy PRESETS if defined
        if (typeof PRESETS !== 'undefined' && PRESETS[key]) {
          applyTemplate(key); // your existing function
          renderPreview();
          if (typeof scheduleAutosave === 'function') scheduleAutosave();
        }
        return;
      }

      // Payload shape: { task, format, context, references, iterate, defaults? }
      const p = row.payload || {};
      const set = (id, val) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = val ? String(val) : '';
      };

      set('tcrei_task',       p.task);
      set('tcrei_format',     p.format);
      set('tcrei_context',    p.context);
      set('tcrei_references', p.references);
      set('tcrei_iterate',    p.iterate);

      // Optional: hydrate the inline vars (Audience/Tone/Length) if provided
      if (p.defaults && p.defaults.vars) {
        const v = p.defaults.vars;
        if (v.audience) document.getElementById('varAudience').value = v.audience;
        if (v.tone)     document.getElementById('varTone').value     = v.tone;
        if (v.length)   document.getElementById('varLength').value   = v.length;
      }

      if (($('methodSelector')?.value === 'tcrei')) {
        renderPreview();
        scheduleAutosave?.();
      }
    }

    function insertAtCursor(id, text){
      const ta = document.getElementById(id);
      if (!ta) return;
      const s = ta.selectionStart ?? ta.value.length;
      const e = ta.selectionEnd ?? ta.value.length;
      const needsNL = ta.value && s > 0 && text && !text.startsWith('\n') ? '\n' : '';
      ta.value = ta.value.slice(0, s) + needsNL + text + ta.value.slice(e);
      ta.focus();
      const pos = ta.value.length;
      ta.selectionStart = ta.selectionEnd = pos;
      if (typeof renderPreview === 'function') renderPreview();
      if (typeof scheduleAutosave === 'function') scheduleAutosave();
    }
    function insertChip(targetId, text){ insertAtCursor(targetId, text); }
    function constraintsWizard() {
      const perf = prompt(
        'Performance budget? (e.g., "TTFB < 200ms; DB queries < 100ms; cache reads")',
        'TTFB < 200ms; DB queries < 100ms; cache reads'
      );
      const sec = prompt(
        'Security expectations? (e.g., "Nonce + capability checks; sanitize/escape; $wpdb->prepare")',
        'Nonce + capability checks; sanitize/escape; $wpdb->prepare'
      );
      const comp = prompt(
        'Compliance/privacy? (e.g., "No PII in logs; respect consent; redact user data in errors")',
        'No PII in logs; respect consent; redact user data in errors'
      );
      const time = prompt(
        'Time/Budget bounds? (e.g., "MVP in 6 hours; no paid APIs")',
        'MVP in 6 hours; no paid APIs'
      );
      const rel = prompt(
        'Reliability/observability? (e.g., "Log in AEST; error handling; retries/backoff")',
        'Log in AEST; error handling; retries/backoff'
      );

      const lines = [];
      if (perf) lines.push(`- Performance: ${perf}`);
      if (sec)  lines.push(`- Security: ${sec}`);
      if (comp) lines.push(`- Compliance: ${comp}`);
      if (time) lines.push(`- Time/Budget: ${time}`);
      if (rel)  lines.push(`- Reliability/Observability: ${rel}`);

      if (lines.length) {
        const block = (val('agent_constraints').trim() ? '\n' : '') + lines.join('\n');
        insertAtCursor('agent_constraints', block);
      }
    }

    // allow inline onclick to call it
    window.constraintsWizard = constraintsWizard;
    // make sure inline onclick="" can see them
    window.insertAtCursor = insertAtCursor;
    window.insertChip = window.insertChip || insertChip;

    async function initTcreiTemplateSelectFromDB() {
      const sel = $('templatePreset');
      if (!sel) return 0;
      sel.disabled = true;
      sel.innerHTML = '<option value="">— Loading templates… —</option>';

      let count = 0;
      try {
        DB_TCREI_TEMPLATES = await fetchTemplates('tcrei');
        sel.innerHTML = '';
        const rows = Object.values(DB_TCREI_TEMPLATES)
          .filter(t => t.is_active !== 0)
          .sort((a,b)=> (a.sort_order - b.sort_order) || (a.label||'').localeCompare(b.label||''));

        if (rows.length) {
          rows.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.key;
            opt.textContent = t.label || t.key;
            sel.appendChild(opt);
          });
          count = rows.length;
        } else {
          // fallback local presets
          Object.entries(TCREI_FALLBACK_PRESETS).forEach(([key, obj]) => {
            const opt = document.createElement('option');
            opt.value = key;
            opt.textContent = obj.label;
            sel.appendChild(opt);
          });
          count = sel.options.length;
        }

        sel.onchange = () => applyTcreiTemplate(sel.value);
        // don’t call apply here if you’re going to do it after both loads
      } catch (e) {
        showAlert('No TCREI templates found in DB — using local fallbacks.','warning');
      } finally {
        sel.disabled = false;
      }
      return count;
    }

    async function initAgentTemplateSelectFromDB() {
      const sel = $('agentTemplate');
      const desc = $('agentTemplateDesc');
      if (!sel) return 0;
      sel.disabled = true;
      sel.innerHTML = '<option value="">— Loading templates… —</option>';

      let count = 0;
      try {
        DB_AGENT_TEMPLATES = await fetchTemplates('agent');
        sel.innerHTML = '';
        const rows = Object.values(DB_AGENT_TEMPLATES)
          .sort((a,b)=> (a.sort_order - b.sort_order) || (a.label||'').localeCompare(b.label||''));

        rows.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.key;
          opt.textContent = t.label || t.key;
          sel.appendChild(opt);
        });
        count = rows.length;

        // selection is applied later after both dropdowns are ready
        sel.addEventListener('change', () => {
          applyAgentTemplate();
          renderPreview();
        });
      } catch (e) {
        console.error('Agent templates load failed:', e);
      } finally {
        sel.disabled = false;
      }
      return count;
    }

    // ========= Generic Bootstrap modal builder =========
    (function () {
      const modalEl   = document.getElementById('wizardModal');
      const formEl    = document.getElementById('wizardForm');
      const titleEl   = document.getElementById('wizardModalTitle');
      const bodyEl    = document.getElementById('wizardModalBody');
      const bsModal   = new bootstrap.Modal(modalEl);
      let submitHandler = null;

      function fieldHtml(f) {
        const id = `wiz_${f.id}`;
        const help = f.help ? `<div class="form-text">${f.help}</div>` : '';
        if (f.type === 'textarea') {
          return `
            <div class="mb-3">
              <label class="form-label" for="${id}">${f.label}</label>
              <textarea class="form-control" id="${id}" placeholder="${f.placeholder||''}" rows="${f.rows||3}">${f.value||''}</textarea>
              ${help}
            </div>`;
        }
        if (f.type === 'select') {
          const opts = (f.options||[]).map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
          return `
            <div class="mb-3">
              <label class="form-label" for="${id}">${f.label}</label>
              <select class="form-select" id="${id}">${opts}</select>
              ${help}
            </div>`;
        }
        if (f.type === 'checkbox') {
          return `
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="${id}" ${f.checked?'checked':''}>
              <label class="form-check-label" for="${id}">${f.label}</label>
            </div>`;
        }
        // default: text
        return `
          <div class="mb-3">
            <label class="form-label" for="${id}">${f.label}</label>
            <input class="form-control" type="text" id="${id}" placeholder="${f.placeholder||''}" value="${f.value||''}">
            ${help}
          </div>`;
      }

      function collect(fields) {
        const out = {};
        for (const f of fields) {
          const id = `wiz_${f.id}`;
          const el = document.getElementById(id);
          if (!el) continue;
          if (f.type === 'checkbox') out[f.id] = !!el.checked;
          else                       out[f.id] = el.value.trim();
        }
        return out;
      }

      window.openWizardModal = function openWizardModal({title, fields, onSubmit}) {
        // build body
        bodyEl.innerHTML = fields.map(fieldHtml).join('');
        titleEl.textContent = title || 'Wizard';
        submitHandler = () => onSubmit(collect(fields));
        bsModal.show();
      };

      // One submit listener reused for all wizards
      formEl.addEventListener('submit', (e) => {
        e.preventDefault();
        try {
          submitHandler && submitHandler();
          bsModal.hide();
        } catch (err) {
          console.error(err);
        }
      });
    })();

    // ========= Agent wizards (use the generic modal) =========

    // Objective
    function objectiveWizard() {
      openWizardModal({
        title: 'Objective',
        fields: [
          { id:'verb',  label:'Action',      type:'select', options:[
            {value:'Implement',label:'Implement'},
            {value:'Fix',label:'Fix'},
            {value:'Research',label:'Research'},
            {value:'Migrate',label:'Migrate'}
          ]},
          { id:'thing', label:'Feature/Thing', placeholder:'e.g., admin action to resend renewal email' },
          { id:'where', label:'Where/Context', placeholder:'e.g., Woo Memberships > User profile' },
          { id:'why',   label:'Why (optional)', placeholder:'e.g., reduce support load and missed renewals' }
        ],
        onSubmit: ({verb,thing,where,why}) => {
          const line = [verb||'Implement', thing||'feature', where ? `in ${where}` : '', why ? `to ${why}` : '']
            .filter(Boolean).join(' ');
          if (line) insertAtCursor('agent_objective', (val('agent_objective').trim() ? '\n' : '') + line);
        }
      });
    }
    window.objectiveWizard = objectiveWizard;

    // Success Criteria
    function successWizard() {
      openWizardModal({
        title: 'Success Criteria',
        fields: [
          { id:'ui',    label:'UI/State',   placeholder:'link shown under Next Bill On' },
          { id:'email', label:'Side effect',placeholder:'correct template sent + logged' },
          { id:'sec',   label:'Security',   placeholder:'nonce + capability checks' },
          { id:'perf',  label:'Performance',placeholder:'page impact < 50ms' },
          { id:'tests', label:'Tests',      placeholder:'unit/integration updated' }
        ],
        onSubmit: (d) => {
          const lines = [];
          if (d.ui)    lines.push(`- ${d.ui}`);
          if (d.email) lines.push(`- ${d.email}`);
          if (d.sec)   lines.push(`- ${d.sec}`);
          if (d.perf)  lines.push(`- ${d.perf}`);
          if (d.tests) lines.push(`- ${d.tests}`);
          if (lines.length) insertAtCursor('agent_success', (val('agent_success').trim() ? '\n' : '') + lines.join('\n'));
        }
      });
    }
    window.successWizard = successWizard;

    // Scope (in-scope)
    function scopeWizard() {
      openWizardModal({
        title: 'Scope (In-Scope)',
        fields: [
          { id:'action',  label:'Action',      placeholder:'add admin link + handler' },
          { id:'reuse',   label:'Reuse assets',placeholder:'reuse existing renewal template' },
          { id:'logging', label:'Observability',placeholder:'log actor, user, time (AEST)' },
          { id:'security',label:'Security',    placeholder:'nonce + capability checks; sanitize/escape' },
          { id:'testing', label:'Testing',     placeholder:'unit/integration where practical' }
        ],
        onSubmit: (d) => {
          const lines = [];
          ['action','reuse','logging','security','testing'].forEach(k => d[k] && lines.push(`- ${d[k]}`));
          if (lines.length) insertAtCursor('agent_scope', (val('agent_scope').trim() ? '\n' : '') + lines.join('\n'));
        }
      });
    }
    window.scopeWizard = scopeWizard;

    // Out of Scope
    function outOfScopeWizard() {
      openWizardModal({
        title: 'Out of Scope',
        fields: [
          { id:'email',    label:'Emails/templates', placeholder:'creating new email templates' },
          { id:'db',       label:'DB/schema',        placeholder:'DB schema changes' },
          { id:'payments', label:'Payments',         placeholder:'subscription proration logic' },
          { id:'provider', label:'Providers',        placeholder:'switching payment provider' }
        ],
        onSubmit: (d) => {
          const lines = [];
          ['email','db','payments','provider'].forEach(k => d[k] && lines.push(`- ${d[k]}`));
          if (lines.length) insertAtCursor('agent_outofscope', (val('agent_outofscope').trim() ? '\n' : '') + lines.join('\n'));
        }
      });
    }
    window.outOfScopeWizard = outOfScopeWizard;

    // Environment
    function envWizard() {
      openWizardModal({
        title: 'Environment Details',
        fields: [
          { id:'php',   label:'PHP',        placeholder:'8.2' },
          { id:'wp',    label:'WordPress',  placeholder:'6.5+' },
          { id:'woo',   label:'Woo/plugins',placeholder:'WooCommerce 8.x' },
          { id:'local', label:'Local/dev',  placeholder:'Win11 (Local by Flywheel)' },
          { id:'prod',  label:'Prod',       placeholder:'Flywheel (NGINX)' },
          { id:'path',  label:'Plugin path',placeholder:'/wp-content/plugins/oi-mods/' },
          { id:'tz',    label:'Timezone',   placeholder:'Australia/Brisbane (AEST; no DST)' }
        ],
        onSubmit: (d) => {
          const lines = [];
          if (d.php)   lines.push(`PHP ${d.php}`);
          if (d.wp)    lines.push(`WordPress ${d.wp}`);
          if (d.woo)   lines.push(d.woo);
          if (d.local) lines.push(`Local: ${d.local}`);
          if (d.prod)  lines.push(`Prod: ${d.prod}`);
          if (d.path)  lines.push(`Plugin: ${d.path}`);
          if (d.tz)    lines.push(`TZ: ${d.tz}`);
          if (lines.length) insertAtCursor('agent_env', (val('agent_env').trim() ? '\n' : '') + lines.join('\n'));
        }
      });
    }
    window.envWizard = envWizard;

    // Vendor Docs
    function vendorWizard() {
      openWizardModal({
        title: 'Vendor Docs',
        fields: [
          { id:'wp',     type:'checkbox', label:'WordPress Developer Docs (core)', checked:true },
          { id:'wc',     type:'checkbox', label:'WooCommerce Memberships Docs',    checked:true },
          { id:'ff',     type:'checkbox', label:'Formidable Forms Developer Docs' },
          { id:'stripe', type:'checkbox', label:'Stripe API Docs (Billing/Invoices)' },
          { id:'host',   type:'checkbox', label:'Flywheel Platform Docs' },
          { id:'extra',  type:'textarea', label:'Other (one per line)', rows:4, placeholder:'e.g., Mailgun API Docs\nWP-CLI Commands' }
        ],
        onSubmit: (d) => {
          const lines = [];
          if (d.wp)     lines.push('- WordPress Developer Docs');
          if (d.wc)     lines.push('- WooCommerce Memberships Docs');
          if (d.ff)     lines.push('- Formidable Forms Developer Docs');
          if (d.stripe) lines.push('- Stripe API Docs (Billing/Invoices)');
          if (d.host)   lines.push('- Flywheel Platform Docs');
          if (d.extra)  d.extra.split('\n').map(s=>s.trim()).filter(Boolean).forEach(s => lines.push(`- ${s}`));
          if (lines.length) insertAtCursor('agent_extra_sources', (val('agent_extra_sources').trim() ? '\n' : '') + lines.join('\n'));
        }
      });
    }
    window.vendorWizard = vendorWizard;

    function applyAgentTemplate() {
      const sel = document.getElementById('agentTemplate');
      const desc = document.getElementById('agentTemplateDesc');
      if (!sel) return;

      const t = DB_AGENT_TEMPLATES[sel.value];
      if (!t) {
        if (desc) desc.textContent = '';
        return;
      }

      // Optional: show short description if your table has it
      if (desc) desc.textContent = t.description || '';

      const d = (t.payload && t.payload.defaults) || {};

      // Prefill only when empty
      const setIfEmpty = (id, val) => {
        if (!val) return;
        const el = document.getElementById(id);
        if (el && !el.value.trim()) el.value = Array.isArray(val) ? val.join('\n') : String(val);
      };

      setIfEmpty('agent_env',         d.env);
      setIfEmpty('agent_scope',       d.scope);
      setIfEmpty('agent_outofscope',  d.outofscope);
      setIfEmpty('agent_constraints', d.constraints);
    }
    function showAlert(message,type='success'){const b=document.getElementById('alert-banner');const m=document.getElementById('alert-message');b.className='alert';b.classList.add(type);m.innerHTML=message;b.style.display='block';b.scrollIntoView({behavior:'smooth',block:'start'});setTimeout(()=>{b.style.display='none';},5000);}
    function normalizeInput(text){return (text||'').trim().replace(/\n{2,}/g,'\n');}   
    function buildAgentObj() {
      if (document.getElementById('methodSelector').value !== 'agent') return { text: '' };

      // Which template?
      const tplKey = (document.getElementById('agentTemplate')?.value) || 'wordpress_programmer';
      const tplRow = DB_AGENT_TEMPLATES[tplKey];
      const p = tplRow?.payload || {};

      // Gather user inputs
      const normalize = normalizeInput;
      const objective    = normalize(document.getElementById('agent_objective').value);
      const success      = normalize(document.getElementById('agent_success').value);
      const scope        = normalize(document.getElementById('agent_scope').value);
      const outofscope   = normalize(document.getElementById('agent_outofscope').value);
      const constraints  = normalize(document.getElementById('agent_constraints').value);
      const env          = normalize(document.getElementById('agent_env').value);
      const extraVendors = normalize(document.getElementById('agent_extra_sources').value);

      // Helpers
      const bullet = (arr, prefix = '-') =>
        (Array.isArray(arr) && arr.length) ? arr.map(x => `${prefix} ${x}`).join('\n') : '';

      const numbered = (arr) =>
        (Array.isArray(arr) && arr.length) ? arr.map((x,i)=> `${i+1}) ${x}`).join('\n') : '';

      const section = (title, body) => body ? `${title}\n${body}` : '';

      // Sections from template
      const roleGoal      = p.roleGoal ? `ROLE & GOAL\n${p.roleGoal}` : '';
      const contextBlock  = section('CONTEXT', bullet(p.context));
      const sourcesBlock  = section('SOURCE PRIORITY', numbered(
        extraVendors ? [...(p.sources||[]), extraVendors] : (p.sources||[])
      ));
      const workflowBlock = section('WORKFLOW', numbered(p.workflow));

      // Output clusters
      const fmt  = bullet(p.output?.format);
      const qual = bullet(p.output?.quality);
      const conf = bullet(p.output?.confirm);

      const outputBlock =
        [
          section('OUTPUT FORMAT', fmt),
          section('QUALITY BARS',  qual),
          section('CONFIRMATION BREAKPOINTS', conf)
        ].filter(Boolean).join('\n\n');

      // User TASK section (always included)
      const taskBlock = `TASK
    - Objective: ${objective || '{{what to achieve}}'}
    - Success criteria: ${success || '{{measurable outcomes}}'}
    - Scope / Out of scope:
    ${scope || '{{in-scope list}}'}${outofscope ? `\n  (Out of scope)\n  ${outofscope}` : ''}
    - Constraints: ${constraints || '{{perf, security, compliance, time, budget}}'}
    - Environment details: ${env || '{{versions, tools, paths}}'}`;

      // Tools & Actions: from template if provided, else a sane default
      const toolsBlock = p.toolsActions
        ? section('TOOLS & ACTIONS', bullet(p.toolsActions))
        : `TOOLS & ACTIONS
    - You may browse the web, read/place files, and create artifacts. For high-impact changes (security, data loss risk), PAUSE and request confirmation before acting.
    - Prefer these source types, in order: vendor/official docs; standards bodies; original blog posts/release notes; well-established community docs. Provide inline citations and a short **Sources** section.`;

      // Compose only non-empty parts
      const text = [
        roleGoal,
        contextBlock,
        taskBlock,
        toolsBlock,
        sourcesBlock,
        workflowBlock,
        outputBlock
      ].filter(Boolean).join('\n\n');

      return {
        text,
        template_key: tplKey,
        objective, success, scope, outofscope, constraints, env, extraVendors
      };
    }

        // ---- AGENT linter ----
    function isPlaceholder(s) {
      const x = (s || '').trim();
      return (
        !x ||
        /\{\{[^}]+\}\}/.test(x) ||  // e.g., {{perf, security…}}
        /^(tbd|n\/?a|\?+)$/i.test(x)
      );
    }

    function lintAgent(obj) {
      const issues = [];
      const hasBullets = s => /(^|\n)\s*-\s+/m.test(s || '');

      if (!obj.objective?.trim()) issues.push('No objective.');
      if (!obj.success?.trim())   issues.push('No success criteria.');
      else {
        // nudge: success should be measurable
        if (!/[<>=]|%|\b(ms|s|minutes?|hours?)\b|\b(pass|fail|green)\b/i.test(obj.success)) {
          issues.push('Success: add measurable checks (e.g., “impact < 50ms”, "%”, pass/fail).');
        }
        if (!hasBullets(obj.success)) issues.push('Success: use bullet points for scanability.');
      }

      if (!obj.scope?.trim() && !obj.outofscope?.trim()) issues.push('No scope / out-of-scope.');
      if (obj.scope && !hasBullets(obj.scope)) issues.push('Scope: prefer bullet list.');
      if (obj.outofscope && !hasBullets(obj.outofscope)) issues.push('Out of scope: prefer bullet list.');

      if (!obj.env?.trim()) issues.push('No environment details.');

      // Constraints checks (from previous message)
      const rawC = (obj.constraints || '').trim();
      if (isPlaceholder(rawC)) {
        issues.push('No constraints provided (perf, security, compliance, time/budget).');
      }
      if (/\b(nice|cool|good|things|stuff)\b/i.test(obj.text)) {
        issues.push('Ambiguous wording detected — be precise.');
      }
      return issues;
    }
    function clearFormFields(){document.querySelectorAll('textarea').forEach(t=>t.value='');document.getElementById('tcrei_add_tags').checked=false;lastRestoredPromptData=null;renderPreview();}
    function deepEqual(a,b){if(a===b)return true;if(a==null||typeof a!='object'||b==null||typeof b!='object')return false;const ka=Object.keys(a),kb=Object.keys(b);if(ka.length!==kb.length)return false;for(const k of ka){if(!kb.includes(k)||!deepEqual(a[k],b[k]))return false}return true}
    async function generatePromptAndSave(method){
      let combinedPrompt = '';
      let promptData = { method };

      if (method === 'tcrei') {
        const obj = buildPromptObj();
        if (!obj.text?.trim()) { showAlert('Fill some TCREI fields first.','warning'); return; }
        combinedPrompt = obj.text;
        Object.assign(promptData, {
          task: obj.task, format: obj.format, context: obj.context,
          references: obj.references, iterate: obj.iterate, addTags: !!obj.addTags
        });
      } else if (method === 'design') {
        const obj = buildDesignObj();
        if (!obj.text?.trim()) { showAlert('Fill some DESIGN fields first.','warning'); return; }
        combinedPrompt = obj.text;
        Object.assign(promptData, {
          description: obj.description, environment: obj.environment, style: obj.style,
          illumination: obj.illumination, gradation: obj.gradation, nuances: obj.nuances,
          references: obj.references
        });
      } else if (method === 'agent') {
        const obj = buildAgentObj();
        if (!obj.objective?.trim()) { showAlert('Please add an Objective for Agent Mode.','warning'); return; }
        combinedPrompt = obj.text;
        Object.assign(promptData, obj);
      }

      if (!combinedPrompt) return;

      let saveToDB = true, sessionPromptTitle = '', isNew = true;
      if (lastRestoredPromptData && deepEqual(promptData, lastRestoredPromptData)) {
        showAlert('No changes detected. Prompt not saved as a new copy.','info');
        saveToDB = false; isNew = false;
        sessionPromptTitle = `Loaded Prompt (No Changes) ${++sessionPromptCounter}`;
      }

      if (saveToDB) {
        const date = new Date();
        const dbSaveTitle = `${method.toUpperCase()} Prompt - ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        const payload = {
          type: method,
          title: dbSaveTitle,
          generated_prompt: combinedPrompt,
          prompt_data: promptData
        };
        const saved = await savePromptToDB(payload);

        if (saved && saved.id) {
          sessionPromptTitle = `${method.toUpperCase()} Session Prompt ${++sessionPromptCounter} - ${date.toLocaleTimeString()}`;
          addPromptToAccordion(sessionPromptTitle, combinedPrompt, promptData, saved.id, '#sessionPromptHistoryContainer');
          document.querySelector('#sessionPromptHistoryContainer .no-prompts-message')?.remove();
        }
      }

      if (sessionPromptTitle && !isNew) {
        addPromptToAccordion(sessionPromptTitle, combinedPrompt, promptData, 'session-'+sessionPromptCounter, '#sessionPromptHistoryContainer');
        document.querySelector('#sessionPromptHistoryContainer .no-prompts-message')?.remove();
      }

      renderPreview();
    }

   async function savePromptToDB(payload) {
      const res = await fetch('php/save_prompt.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const bodyText = await res.text();

      if (!res.ok) {
        throw new Error(`HTTP ${res.status} ${res.statusText} — ${bodyText || '(empty response)'}`);
      }
      if (!bodyText || !bodyText.trim()) {
        throw new Error('Server returned an empty response body.');
      }

      let data;
      try { data = JSON.parse(bodyText); }
      catch { throw new Error(`Invalid JSON from server: ${bodyText.slice(0, 400)}`); }

      // Support both shapes:
      //  - { ok: true, id, prompt: {...} }   (recommended)
      //  - { message: '...', prompt: {...} } (older)
      if (data.ok === false) throw new Error(data.error || 'Server returned ok:false');

      const record = data.prompt || data; // be tolerant
      return {
        ok: data.ok !== false,
        id: record.id,
        prompt: record
      };
    }

    async function deletePrompt(id){
      if(!confirm('Delete this prompt from the database?')) return;
      try{
        const res = await fetch('php/delete_prompt.php', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({id})
        });
        const txt = await res.text();
        const json = (()=>{ try { return JSON.parse(txt); } catch { return null; }})();
        if (!res.ok) throw new Error((json && json.error) || txt || 'Failed to delete');
        showAlert((json && json.message) || 'Deleted','success');
        searchPrompts(currentSearchPage);
      }catch(err){
        console.error(err);
        showAlert(`Error deleting prompt: ${err.message}`,'error');
      }
    }

    async function searchPrompts(page = 1, isSearchButtonClicked = false) {
      const searchType   = document.getElementById('searchPromptType').value;
      const searchKeyword= document.getElementById('searchKeyword').value;

      // NEW controls
      const sortBy   = document.getElementById('searchSortBy').value || 'created_at';
      const sortDir  = document.getElementById('searchSortDir').value || 'desc';
      const mode     = document.getElementById('searchMode').value || 'auto';
      const includeDeleted = document.getElementById('includeDeleted').checked ? 1 : 0;

      currentSearchPage = page;

      // Validation (only when user explicitly clicks Search)
      if (isSearchButtonClicked && searchKeyword.trim() === '' && searchType === 'All') {
        showAlert("Please enter a search keyword or select a specific prompt type.", 'warning');
        document.getElementById('searchResultsContainer').innerHTML =
          '<p class="no-prompts-message">Search results will appear here. Use "List All Prompts" to see all saved entries.</p>';
        document.getElementById('clearAllDbPrompts').style.display = 'none';
        updatePaginationControls(0, 0);
        return;
      }

      const searchResultsContainer = document.getElementById('searchResultsContainer');
      searchResultsContainer.innerHTML = '<p class="no-prompts-message">Searching...</p>';
      document.getElementById('clearAllDbPrompts').style.display = 'none';

      const queryParams = new URLSearchParams({
        page: currentSearchPage,
        limit: promptsPerPage,
        sort_by: sortBy,
        sort_dir: sortDir,
        search_mode: mode
      });

      if (searchType !== 'All') {
        queryParams.append('type', searchType);
      }
      if (searchKeyword.trim() !== '') {
        queryParams.append('keyword', searchKeyword.trim());
      }
      if (includeDeleted) {
        queryParams.append('include_deleted', '1'); // backend auto-ignores if column not present
      }

      try {
        const response = await fetch(`php/search_prompts.php?${queryParams.toString()}`);
        if (!response.ok) throw new Error('Failed to fetch search results');

        const result = await response.json();

        searchResultsContainer.innerHTML = '';

        if (!result.prompts || result.prompts.length === 0) {
          searchResultsContainer.innerHTML = '<p class="no-prompts-message">No matching prompts found.</p>';
          document.getElementById('clearAllDbPrompts').style.display = 'none';
        } else {
          result.prompts.forEach(prompt => {
            addPromptToAccordion(prompt.title, prompt.generated_prompt, prompt.prompt_data, prompt.id, '#searchResultsContainer');
          });
          document.getElementById('clearAllDbPrompts').style.display = 'block';
        }

        totalPages = result.total_pages || 1;
        currentSearchPage = result.current_page || 1;
        updatePaginationControls();

      } catch (error) {
        console.error('Error searching prompts:', error);
        searchResultsContainer.innerHTML =
          '<p class="no-prompts-message" style="color:red;">Error searching prompts. Please check the server connection and PHP scripts.</p>';
        showAlert(`Error searching prompts: ${error.message}`, 'error');
        updatePaginationControls(0, 0);
      }
    }

    function restorePrompt(data){
      clearFormFields(); lastRestoredPromptData=data;
      const method=data.method; document.getElementById('methodSelector').value=method; showMethodFields();
      if(method==='tcrei'){
        document.getElementById('tcrei_task').value=data.task||'';
        document.getElementById('tcrei_format').value=data.format||'';
        document.getElementById('tcrei_context').value=data.context||'';
        document.getElementById('tcrei_references').value=data.references||'';
        document.getElementById('tcrei_iterate').value=data.iterate||'';
        document.getElementById('tcrei_add_tags').checked=!!data.addTags;
      }else{
        document.getElementById('design_description').value=data.description||'';
        document.getElementById('design_environment').value=data.environment||'';
        document.getElementById('design_style').value=data.style||'';
        document.getElementById('design_illumination').value=data.illumination||'';
        document.getElementById('design_gradation').value=data.gradation||'';
        document.getElementById('design_nuances').value=data.nuances||'';
        document.getElementById('design_references').value=data.references||'';
      }
      renderPreview(); showAlert('Prompt loaded for editing.','success'); window.scrollTo({top:0,behavior:'smooth'});
    }
    function showMethodFields() {
        const method = document.getElementById('methodSelector')?.value || 'tcrei';
        const map = {
          tcrei:  'tcreiMethod',
          design: 'designMethod',
          agent:  'agentMethod' // safe even if you haven't added Agent yet
        };

        ['tcreiMethod','designMethod','agentMethod'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.classList.toggle('active', id === map[method]);
        });

        // Your existing preview function already exists; call it
        if (typeof renderPreview === 'function') renderPreview();
      }
    function addPromptToAccordion(title,text,data,id,containerSel){
      const container=document.querySelector(containerSel);
      const item=document.createElement('div'); item.classList.add('accordion-item'); item.dataset.prompt=JSON.stringify(data); item.dataset.uniqueId=id;
      const btn=document.createElement('button'); btn.classList.add('accordion-button'); btn.textContent=title;
      btn.onclick=function(){ this.classList.toggle('active'); const panel=this.nextElementSibling;
        if(panel.classList.contains('active')){ panel.classList.remove('active'); panel.style.maxHeight=null; }
        else{ panel.classList.add('active'); panel.style.maxHeight=(panel.scrollHeight+80)+'px'; }
      };
      const panel=document.createElement('div'); panel.classList.add('accordion-panel');
      const pre=document.createElement('pre'); pre.textContent=text;
      const bg=document.createElement('div'); bg.classList.add('button-group');
      const copyBtn=document.createElement('button'); copyBtn.classList.add('copy-button'); copyBtn.textContent='Copy';
      copyBtn.onclick=(e)=>{e.stopPropagation(); copyToClipboard(text,copyBtn);};
      const restoreBtn=document.createElement('button'); restoreBtn.classList.add('load-button'); restoreBtn.textContent='Load for Editing';
      restoreBtn.onclick=(e)=>{e.stopPropagation(); restorePrompt(data);};
      bg.appendChild(copyBtn); bg.appendChild(restoreBtn);
      if(containerSel==='#searchResultsContainer'){const del=document.createElement('button'); del.classList.add('delete-button'); del.textContent='Delete'; del.onclick=(e)=>{e.stopPropagation(); deletePrompt(id);}; bg.appendChild(del);}
      panel.appendChild(pre); panel.appendChild(bg); item.appendChild(btn); item.appendChild(panel); container.prepend(item);
      if(containerSel==='#sessionPromptHistoryContainer'){ btn.click(); item.scrollIntoView({behavior:'smooth',block:'end'}); }
    }

    function copyToClipboard(text,btn){ if(!text){showAlert('No prompt to copy.','warning');return;}
      const ta=document.createElement('textarea'); ta.value=text; ta.style.position='absolute'; ta.style.left='-9999px'; document.body.appendChild(ta);
      const original=btn?.textContent||'Copy';
      try{ ta.select(); document.execCommand('copy'); if(btn){btn.textContent='Copied!'; setTimeout(()=>btn.textContent=original,2000);} showAlert('Prompt copied to clipboard!','success');}
      catch(err){console.error(err);showAlert('Failed to copy.','error');}
      finally{document.body.removeChild(ta);}
    }

    function listAllPrompts() {
      document.getElementById('searchPromptType').value = 'All';
      document.getElementById('searchKeyword').value = '';
      document.getElementById('searchSortBy').value = 'created_at';
      document.getElementById('searchSortDir').value = 'desc';
      document.getElementById('searchMode').value = 'auto';
      document.getElementById('includeDeleted').checked = false;

      searchPrompts(1, false);
    }
    function changePage(d){const p=currentSearchPage+d; if(p>=1&&p<=totalPages){searchPrompts(p,true);}}
    function updatePaginationControls(cur=currentSearchPage,tot=totalPages){document.getElementById('currentPageSpan').textContent=`Page ${cur} of ${tot}`;document.getElementById('prevPageBtn').disabled=(cur===1);document.getElementById('nextPageBtn').disabled=(cur===tot||tot===0);}

    document.getElementById('clearAllDbPrompts').onclick = async function () {
      if (!confirm('Clear ALL saved prompts from the database?')) return;
      try {
        const res = await fetch('php/clear_all_prompts.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          // read text to avoid a second .json() call when server returns non-JSON
          const eText = await res.text();
          throw new Error(eText || 'Failed to clear');
        }

        const result = await res.json();
        showAlert(result.message, 'success');
        listAllPrompts();
      } catch (err) {
        console.error(err);
        showAlert(`Error: ${err.message}`, 'error');
      }
    };

    function withVariables(text){
      const rep = {
        '{{audience}}': val('varAudience') || '',
        '{{tone}}':     val('varTone')     || '',
        '{{length}}':   val('varLength')   || '',
        '{{topic}}':    'your topic'
      };
      return Object.keys(rep).reduce((acc,k)=>acc.split(k).join(rep[k]), text||'');
    }

function lintPrompt(obj){
  const issues = [];
  const t = [obj.task, obj.format, obj.context, obj.references, obj.iterate]
              .filter(Boolean).join(' ');

  const audienceVar = val('varAudience').trim();
  const lengthVar   = val('varLength').trim();
  const toneVar     = val('varTone').trim();

  const hasAudience =
    audienceVar.length > 0 ||
    /Audience:\s*[^\s{}]/i.test(t);

  const hasLength =
    lengthVar.length > 0 ||
    /Length:\s*[^\s{}]/i.test(t) ||
    /\b~?\d+\s*(words?|chars?|tokens?)\b/i.test(t);

  const hasTone =
    toneVar.length > 0 ||
    /Tone:\s*[^\s{}]/i.test(t);

  if (!obj.task?.trim()) issues.push('No task provided.');
  if (!hasAudience)       issues.push('No audience specified.');
  if (!hasLength)         issues.push('No length guidance.');
  if (!hasTone)           issues.push('No tone specified.');

  if ((t.match(/\b(very|really|stuff|things)\b/gi)||[]).length > 3)
    issues.push('Ambiguous words detected (very/really/stuff/things).');
  if ((t.match(/\band also\b/gi)||[]).length > 0)
    issues.push('Redundant phrase: "and also".');

  return issues;
}

    function estimateTokens(s){const chars=(s||'').length; const words=(s||'').trim().split(/\s+/).filter(Boolean).length; const a=Math.ceil(chars/4), b=Math.ceil(words/0.75); return Math.round((a+b)/2);}
    function ensureVarsInContext(ctx){
      const a = val('varAudience').trim();
      const t = val('varTone').trim();
      const l = val('varLength').trim();

      const add = [];
      if (!/Audience:/i.test(ctx) && a) add.push(`Audience: ${a}`);
      if (!/Tone:/i.test(ctx)     && t) add.push(`Tone: ${t}`);
      if (!/Length:/i.test(ctx)   && l) add.push(`Length: ${l}`);

      if (add.length) {
        ctx = (ctx ? ctx + '\n' : '') + add.join('\n');
      }
      return ctx;
    }
    function ensureVarsInContext(ctx){
      const a = val('varAudience').trim();
      const t = val('varTone').trim();
      const l = val('varLength').trim();

      const add = [];
      if (!/Audience:/i.test(ctx) && a) add.push(`Audience: ${a}`);
      if (!/Tone:/i.test(ctx)     && t) add.push(`Tone: ${t}`);
      if (!/Length:/i.test(ctx)   && l) add.push(`Length: ${l}`);

      if (add.length) ctx = (ctx ? ctx + '\n' : '') + add.join('\n');
      return ctx;
    }
    function stripContextLabels(ctx) {
      ctx = (ctx || '');
      const lines = ctx.split(/\r?\n/).filter(line => !/^\s*(Audience|Tone|Length)\s*:/i.test(line));
      return lines.join('\n').replace(/\n{3,}/g, '\n\n').trim();
    }

  // Always override those labels with the side inputs (only add if non-empty)
  function ensureVarsInContext(ctx){
    const a = val('varAudience').trim();
    const t = val('varTone').trim();
    const l = val('varLength').trim();

    ctx = stripContextLabels(ctx);

    const add = [];
    if (a) add.push(`Audience: ${a}`);
    if (t) add.push(`Tone: ${t}`);
    if (l) add.push(`Length: ${l}`);

    if (add.length) ctx = (ctx ? ctx + '\n' : '') + add.join('\n');
    return ctx;
  }

function buildPromptObj(){
  const methodSel = document.getElementById('methodSelector');
  if (!methodSel || methodSel.value !== 'tcrei') return { text: '' };

  const addTags = !!document.getElementById('tcrei_add_tags')?.checked;
  const mode    = document.getElementById('modeSelector')?.value || '';

  const get = (id) => (document.getElementById(id)?.value || '').trim();
  const W   = (s) => withVariables(s); // keep your existing function

  let task       = W(get('tcrei_task'));
  let format     = W(get('tcrei_format'));
  let context = W(get('tcrei_context'));
  context = ensureVarsInContext(context);
  let references = W(get('tcrei_references'));
  let iterate    = W(get('tcrei_iterate'));

  if (iterate) {
    iterate = `Before finalising, critique your own draft against these criteria, then revise:\n${iterate}`;
  }

  let modeHint = '';
  if (mode === 'concise')  modeHint = 'Please keep the response concise and to the point.';
  if (mode === 'creative') modeHint = 'Embrace creativity and original turns of phrase.';
  if (mode === 'factual')  modeHint = 'Be strictly factual and cite sources where possible.';

  if (addTags) {
    const blocks = [];
    if (task)       blocks.push(`<task>${task}</task>`);
    if (format)     blocks.push(`<format>${format}</format>`);
    if (context)    blocks.push(`<context>${context}</context>`);
    if (references) blocks.push(`<references>${references}</references>`);
    if (iterate)    blocks.push(`<revise>${iterate}</revise>`);
    if (modeHint)   blocks.push(`<mode>${modeHint}</mode>`);
    return { addTags:true, text: blocks.join('\n'), task, format, context, references, iterate };
  } else {
    const parts = [];
    if (task)       parts.push(task);
    if (format)     parts.push(format);
    if (context)    parts.push(context);
    if (references) parts.push(references);
    if (iterate)    parts.push(`Revise with:\n${iterate}`);
    if (modeHint)   parts.push(modeHint);
    return { addTags:false, text: parts.join(' '), task, format, context, references, iterate };
  }
}

 function renderPreview() {
    const live = document.getElementById('livePreview');
    const lint = document.getElementById('linter');
    const len  = document.getElementById('lengthInfo');
    const method = document.getElementById('methodSelector').value;

    const h3s = document.querySelectorAll('.side-panel h3');
    if (h3s[0]) {
      h3s[0].textContent =
        method === 'design' ? 'Final Prompt Preview (DESIGN)' :
        method === 'agent'  ? 'Final Prompt Preview (AGENT)'  :
                              'Final Prompt Preview (TCREI)';
    }

    let obj = { text: '' }, issues = [];
    if (method === 'tcrei') {
      obj = buildPromptObj(); // now null-safe
      issues = lintPrompt(obj);
    } else if (method === 'design') {
      obj = buildDesignObj();
      issues = lintDesign(obj);
    } else if (method === 'agent') {
      obj = buildAgentObj();
      issues = lintAgent(obj);
    }

    live.textContent = obj.text || (method === 'design'
      ? 'Start typing to see a live preview for DESIGN…'
      : method === 'agent'
        ? 'Start typing to see a live preview for AGENT…'
        : 'Start typing to see a live preview for TCREI…');

    lint.innerHTML = issues.length ? ('⚠️ ' + issues.join('<br>')) : '✔️ Looks good';

    const tokens = estimateTokens(obj.text);
    const chars  = obj.text.length;
    const words  = obj.text.trim() ? obj.text.trim().split(/\s+/).length : 0;
    const warn   = tokens > 3500 ? ' — near/over typical 4K limit' : '';
    len.innerHTML = `Chars: ${chars} • Words: ${words} • Est. tokens: ${tokens}${warn}`;
  }
    function makeABVariants(){
      const base=buildPromptObj(); if(!base.text.trim()){showAlert('Nothing to variant — fill some fields first.','warning');return;}
      const A=base.text.replace(/Tone:[^\n]+/i,'Tone: friendly and concise');
      const B=base.text.replace(/Tone:[^\n]+/i,'Tone: persuasive and energetic');
      addPromptToAccordion('Variant A',A,{method:'tcrei',variant:'A'},'ab-A-'+Date.now(),'#sessionPromptHistoryContainer');
      addPromptToAccordion('Variant B',B,{method:'tcrei',variant:'B'},'ab-B-'+Date.now(),'#sessionPromptHistoryContainer');
      showAlert('Generated A/B variants in session history.','success');
    }

    const RANDOM_SETS={task:[
      'Write a blog post explaining {{topic}} to {{audience}}.',
      'Draft a social post series (5 posts) on {{topic}}.',
      'Summarise a long article into bullet points for {{audience}}.',
      'Create a how-to guide for {{topic}} with steps.'
    ]};
    function randomiseField(id,key){const arr=RANDOM_SETS[key]||[]; if(!arr.length)return; const choice=arr[Math.floor(Math.random()*arr.length)]; document.getElementById(id).value=choice; renderPreview(); scheduleAutosave();}

    const DRAFT_KEY = 'prompt_draft_v1';
    if (window.__autosaveTimer === undefined) window.__autosaveTimer = null;

    function scheduleAutosave() {
      const b = $('autosaveStatus');
      if (b) b.textContent = 'Autosave: typing…';
      if (window.__autosaveTimer) clearTimeout(window.__autosaveTimer);
      window.__autosaveTimer = setTimeout(saveDraft, 600);
    }
    function currentPromptData() {
      const method = $('methodSelector')?.value || 'tcrei';

      if (method === 'tcrei') {
        // Only read if the TCREI nodes exist
        return {
          method,
          task:        val('tcrei_task'),
          format:      val('tcrei_format'),
          context:     val('tcrei_context'),
          references:  val('tcrei_references'),
          iterate:     val('tcrei_iterate'),
          addTags:     checked('tcrei_add_tags'),
          vars: {
            audience:  val('varAudience'),
            tone:      val('varTone'),
            length:    val('varLength')
          },
          mode:        val('modeSelector')
        };
      }

      if (method === 'design') {
        return {
          method,
          description: val('design_description'),
          environment: val('design_environment'),
          style:       val('design_style'),
          illumination:val('design_illumination'),
          gradation:   val('design_gradation'),
          nuances:     val('design_nuances'),
          references:  val('design_references')
        };
      }

      if (method === 'agent') {
        return {
          method,
          objective:    val('agent_objective'),
          success:      val('agent_success'),
          scope:        val('agent_scope'),
          outofscope:   val('agent_outofscope'),
          constraints:  val('agent_constraints'),
          env:          val('agent_env'),
          extraVendors: val('agent_extra_sources'),
          // keep template_key elsewhere if you store it
        };
      }

      // Fallback
      return { method };
    }


    // Add the agent IDs to the listeners registration array: 
    function saveDraft(){
      const data = currentPromptData(); // now null-safe
      try {
        localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
        setAutosaveStatus('saved','Autosave: saved');
        const b = $('autosaveStatus');
        if (b) b.textContent = 'Autosave: saved';
      } catch (e) {
        console.warn('Autosave failed:', e);
      }
    }
    function restoreDraft(){const raw=localStorage.getItem(DRAFT_KEY); if(!raw){showAlert('No draft found.','info');return;} const d=JSON.parse(raw);
      if(d.method==='tcrei'){document.getElementById('tcrei_task').value=d.task||'';document.getElementById('tcrei_format').value=d.format||'';document.getElementById('tcrei_context').value=d.context||'';document.getElementById('tcrei_references').value=d.references||'';document.getElementById('tcrei_iterate').value=d.iterate||'';document.getElementById('tcrei_add_tags').checked=!!d.addTags;document.getElementById('varAudience').value=d.vars?.audience||'';document.getElementById('varTone').value=d.vars?.tone||'';document.getElementById('varLength').value=d.vars?.length||'';document.getElementById('modeSelector').value=d.mode||'';renderPreview();showAlert('Draft restored.','success');}}
    function clearDraft(){localStorage.removeItem(DRAFT_KEY); setAutosaveStatus('clear','Autosave: cleared'); const b=document.getElementById('autosaveStatus'); if(b) b.textContent='Autosave: cleared';}
    [
      'tcrei_task','tcrei_format','tcrei_context','tcrei_references','tcrei_iterate','tcrei_add_tags',
        'design_description','design_environment','design_style','design_illumination','design_gradation','design_nuances','design_references',
        // AGENT fields:
        'agentTemplate', 
        'agent_objective','agent_success','agent_scope','agent_outofscope','agent_constraints','agent_env','agent_extra_sources',
        // shared
        'varAudience','varTone','varLength','modeSelector','methodSelector'
    ].forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      const ev=(id==='tcrei_add_tags'||id==='methodSelector'||id==='modeSelector')?'change':'input';
      el.addEventListener(ev,()=>{renderPreview(); scheduleAutosave();});
    });
    function copyPreview(clean=false){
      const obj = buildActiveObj();
      const text = clean ? (obj.text||'').replace(/<\/?[^>]+(>|$)/g,'') : (obj.text||'');
      copyToClipboard(text,{textContent:'Copied'});
    }
    function exportPrompt(){const data=currentPromptData(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`prompt-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);}
    function importPrompt(e){const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{try{const d=JSON.parse(ev.target.result); if(d.method!=='tcrei') throw new Error('Not a TCREI prompt file.');
      document.getElementById('tcrei_task').value=d.task||'';document.getElementById('tcrei_format').value=d.format||'';document.getElementById('tcrei_context').value=d.context||'';document.getElementById('tcrei_references').value=d.references||'';document.getElementById('tcrei_iterate').value=d.iterate||'';document.getElementById('tcrei_add_tags').checked=!!d.addTags;document.getElementById('varAudience').value=d.vars?.audience||'';document.getElementById('varTone').value=d.vars?.tone||'';document.getElementById('varLength').value=d.vars?.length||'';document.getElementById('modeSelector').value=d.mode||''; renderPreview(); scheduleAutosave(); showAlert('Prompt imported.','success');}
      catch(err){showAlert('Import failed: '+err.message,'error');}}; r.readAsText(f);}

    document.addEventListener('keydown',e=>{const cmd=e.metaKey||e.ctrlKey; if(!cmd)return; if(e.key.toLowerCase()==='enter'){e.preventDefault(); generatePromptAndSave('tcrei');} if(e.key.toLowerCase()==='k'){e.preventDefault(); clearFormFields(); renderPreview();} if(e.key==='/'){e.preventDefault(); document.querySelectorAll('.tooltiptext').forEach(tt=>{tt.style.visibility=(tt.style.visibility==='visible')?'hidden':'visible'; tt.style.opacity=(tt.style.opacity==='1')?'0':'1';});}});
    // --- top-level (once) ---
    let __APP_INITIALIZED__ = false;          // per-navigation guard

    // Optional: “first time ever” (cross-session) flag
    function markFirstRunOnce(){
      const key = '__gpc_first_run__';
      const firstRun = !localStorage.getItem(key);
      if (firstRun){
        localStorage.setItem(key, '1');
        // You could show a one-time tip here if you want.
      }
      return firstRun;
    }

    // Single init for the whole app
    async function initAppOnce(){
      if (__APP_INITIALIZED__) return;
      __APP_INITIALIZED__ = true;

      setAutosaveStatus('idle','Autosave: idle');

      await initAgentTemplateSelectFromDB();
      await initTcreiTemplateSelectFromDB();

      showMethodFields();
      toggleTemplateVisibility();
      // Search UI defaults
      document.getElementById('searchResultsContainer').innerHTML =
        '<p class="no-prompts-message">Search results will appear here. Use "List All Prompts" to see all saved entries.</p>';
      document.getElementById('clearAllDbPrompts').style.display = 'none';
      updatePaginationControls();

      // Restore prior search preferences
      const prefs = JSON.parse(localStorage.getItem('search_prefs') || '{}');
      if (prefs.type)  document.getElementById('searchPromptType').value = prefs.type;
      if (prefs.kw)    document.getElementById('searchKeyword').value   = prefs.kw;
      if (prefs.by)    document.getElementById('searchSortBy').value    = prefs.by;
      if (prefs.dir)   document.getElementById('searchSortDir').value   = prefs.dir;
      if (prefs.mode)  document.getElementById('searchMode').value      = prefs.mode;
      if (prefs.del)   document.getElementById('includeDeleted').checked = !!prefs.del;

      // Persist any changes to the search controls
      ['searchPromptType','searchKeyword','searchSortBy','searchSortDir','searchMode','includeDeleted']
        .forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('change', () => {
            localStorage.setItem('search_prefs', JSON.stringify({
              type: document.getElementById('searchPromptType').value,
              kw:   document.getElementById('searchKeyword').value,
              by:   document.getElementById('searchSortBy').value,
              dir:  document.getElementById('searchSortDir').value,
              mode: document.getElementById('searchMode').value,
              del:  document.getElementById('includeDeleted').checked ? 1 : 0
            }));
          });
        });

      setTimeout(() => { renderPreview(); }, 0);

        // sanity logs
        console.log('TCREI options:', document.getElementById('templatePreset')?.options.length);
        console.log('AGENT options:', document.getElementById('agentTemplate')?.options.length);
      }

    // ONE listener only
    document.addEventListener('DOMContentLoaded', initAppOnce);

    // If script might be injected late or re-run, also protect with:
    if (document.readyState === 'interactive' || document.readyState === 'complete') {
      initAppOnce();
    }
    // --- DESIGN builder ---
    function buildDesignObj() {
      if (document.getElementById('methodSelector').value !== 'design') return { text: '' };

      const description  = normalizeInput(document.getElementById('design_description').value);
      const environment  = normalizeInput(document.getElementById('design_environment').value);
      const style        = normalizeInput(document.getElementById('design_style').value);
      const illumination = normalizeInput(document.getElementById('design_illumination').value);
      const gradation    = normalizeInput(document.getElementById('design_gradation').value);
      const nuances      = normalizeInput(document.getElementById('design_nuances').value);
      const references   = normalizeInput(document.getElementById('design_references').value);

      // Build a labeled preview like TCREI does
      const lines = [];
      if (description)  lines.push(`Description: ${description}`);
      if (environment)  lines.push(`Environment: ${environment}`);
      if (style)        lines.push(`Style: ${style}`);
      if (illumination) lines.push(`Illumination: ${illumination}`);
      if (gradation)    lines.push(`Quality/Gradation: ${gradation}`);
      if (nuances)      lines.push(`Nuances: ${nuances}`);
      if (references)   lines.push(`References: ${references}`);

      return {
        text: lines.join('\n'),
        description, environment, style, illumination, gradation, nuances, references
      };
    }

    // --- DESIGN linter ---
    function lintDesign(obj) {
      const issues = [];
      const t = [
        obj.description, obj.environment, obj.style,
        obj.illumination, obj.gradation, obj.nuances, obj.references
      ].filter(Boolean).join(' ');

      if (!obj.description?.trim()) issues.push('No description (subject & action).');
      if (!obj.environment?.trim()) issues.push('No environment/setting specified.');
      if (!obj.style?.trim())       issues.push('No artistic style/aesthetic specified.');
      if (!obj.illumination?.trim())issues.push('No illumination/time-of-day specified.');      
      if (/\b(nice|cool|good|thing|stuff)\b/i.test(t)) {
        issues.push('Ambiguous words detected (nice/cool/good/stuff). Be precise.');
      }
      return issues;
    }
    // Build whichever method is active
    function buildActiveObj() {
      const method = document.getElementById('methodSelector').value;
      if (method === 'tcrei')  return buildPromptObj();
      if (method === 'design') return buildDesignObj();
      if (method === 'agent')  return buildAgentObj();
      return { text: '' };
    }
    function toggleTemplateVisibility() {
      const method = document.getElementById('methodSelector')?.value || 'tcrei';
      const inline = document.querySelector('.inline-controls');
      if (inline) inline.style.display = (method === 'tcrei') ? 'flex' : 'none';

      // Agent template lives inside the Agent section — just let showMethodFields() handle it.
      // If you still want to force show/hide the <select> container:
      const agentTplWrap = document.getElementById('agentTemplate')?.closest('div');
      if (agentTplWrap) agentTplWrap.style.display = (method === 'agent') ? '' : 'none';
    }

    // call on method change
    document.getElementById('methodSelector').addEventListener('change', () => {
      showMethodFields();
      toggleTemplateVisibility();
    });

    function stripPlaceholders(text){
      return (text||'')
        .replace(/^.*\{\{[^}]+\}\}.*$/gm, '')   // remove lines containing a {{placeholder}}
        .replace(/\n{3,}/g, '\n\n')
        .trim();
    }    
  </script>
</body>
</html>
